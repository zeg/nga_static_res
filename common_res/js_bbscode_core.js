if (!window.ubbcode)var ubbcode={}
if (!window.__IMGPATH)var __IMGPATH = 'http://img4.ngacn.cc/ngabbs'

ubbcode.fonts = {
'simsun':'宋体',
'simhei':'黑体',
'Arial':'Arial',
'Arial Black':'Arial Black',
'Book Antiqua':'Book Antiqua',
'Century Gothic':'Century Gothic',
'Comic Sans MS':'Comic Sans MS',
'Courier New':'Courier New',
'Georgia':'Georgia',
'Impact':'Impact',
'Tahoma':'Tahoma',
'Times New Roman':'Times New Roman',
'Trebuchet MS':'Trebuchet MS',
'Script MT Bold':'Script MT Bold',
'Stencil':'Stencil',
'Verdana':'Verdana',
'Lucida Console':'Lucida Console'
}

ubbcode.fontSize = {
'100%':'100%',
'110%':'110%',
'120%':'120%',
'130%':'130%',
'150%':'150%'
}

ubbcode.fontColor = {
'skyblue':0,
'royalblue':0,
'blue':0,
'darkblue':0,
'orange':0,
'orangered':0,
'crimson':0,
'red':0,
'firebrick':0,
'darkred':0,
'green':0,
'limegreen':0,
'seagreen':0,
'teal':0,
'deeppink':0,
'tomato':0,
'coral':0,
'purple':0,
'indigo':0,
'burlywood':0,
'sandybrown':0,
'sienna':0,
'chocolate':0,
'silver':0
}

ubbcode.smilesN={
0:'默认',
ac:'AC娘',
a2:'AC娘',
pst:'潘斯特',
dt:'外域三人组',
pg:'企鹅'
}
ubbcode.smiles = {
0:{

1:'smile.gif',
2:'mrgreen.gif',
3:'question.gif',
4:'wink.gif',
5:'redface.gif',
6:'sad.gif',
7:'cool.gif',
8:'crazy.gif',
32:'12.gif',
33:'13.gif',
34:'14.gif',
30:'10.gif',
29:'09.gif',
28:'08.gif',
27:'07.gif',
26:'06.gif',
25:'05.gif',
24:'04.gif',
35:'15.gif',
36:'16.gif',
37:'17.gif',
38:'18.gif',
39:'19.gif',
40:'20.gif',
41:'21.gif',
42:'22.gif',
43:'23.gif'
},

ac:{
"blink":	"ac0.png",
"goodjob":	"ac1.png",
"上":	"ac2.png",
"中枪":	"ac3.png",
"偷笑":	"ac4.png",
"冷":	"ac5.png",
"凌乱":	"ac6.png",
"反对":	"ac7.png",
"吓":	"ac8.png",
"吻":	"ac9.png",
"呆":	"ac10.png",
"咦":	"ac11.png",
"哦":	"ac12.png",
"哭":	"ac13.png",
"哭1":	"ac14.png",
"哭笑":	"ac15.png",
"哼":	"ac16.png",
"喘":	"ac17.png",
"喷":	"ac18.png",
"嘲笑":	"ac19.png",
"嘲笑1":	"ac20.png",
"":	"ac21.png",
"委屈":	"ac22.png",
"心":	"ac23.png",
"忧伤":	"ac24.png",
"怒":	"ac25.png",
"怕":	"ac26.png",
"惊":	"ac27.png",
"愁":	"ac28.png",
"抓狂":	"ac29.png",
"抠鼻":	"ac30.png",
"擦汗":	"ac31.png",
"无语":	"ac32.png",
"晕":	"ac33.png",
"汗":	"ac34.png",
"瞎":	"ac35.png",
"羞":	"ac36.png",
"羡慕":	"ac37.png",
"花痴":	"ac38.png",
"茶":	"ac39.png",
"衰":	"ac40.png",
"计划通":	"ac41.png",
"赞同":	"ac42.png",
"闪光":	"ac43.png",
"黑枪":	"ac44.png"

},

a2:{
"goodjob":	"a2_02.png",
"诶嘿":	"a2_05.png",
"偷笑":	"a2_03.png",
"怒":	"a2_04.png",
"笑":	"a2_07.png",
"那个…":	"a2_08.png",
"哦嗬嗬嗬":	"a2_09.png",
"舔":	"a2_10.png",
"鬼脸":	"a2_14.png",
"冷":	"a2_16.png",
"大哭":	"a2_15.png",
"哭":	"a2_17.png",
"恨":	"a2_21.png",
"中枪":	"a2_23.png",
"":	"a2_24.png",
"你看看你":	"a2_25.png",
"doge":	"a2_27.png",
"自戳双目":	"a2_28.png",
"偷吃":	"a2_30.png",
"冷笑":	"a2_31.png",
"壁咚":	"a2_32.png",
"不活了":	"a2_33.png",
"不明觉厉":	"a2_36.png",
"是在下输了": "a2_51.png",
"你为猴这么":	"a2_53.png",
"干杯":	"a2_54.png",
"干杯2":	"a2_55.png",
"异议":	"a2_47.png",//"逆转裁判",
"认真":	"a2_48.png",//"斡窭鲜",
"你已经死了":	"a2_45.png",//"拳四O",
"你这种人…":	"a2_49.png",//"北方栖姬",
"妮可妮可妮":	"a2_18.png",//"矢泽妮可",
"惊":	"a2_19.png",//"原田海未",
"抢镜头":	"a2_52.png",//"南小鸟",
"yes":	"a2_26.png",//"佐仓千代",
"有何贵干":	"a2_11.png",//"在下坂本",
"病娇":	"a2_12.png",//"我妻由乃",
"lucky":	"a2_13.png",//"泉此方",
"poi":	"a2_20.png",//"夕立",
"2":	"a2_22.png",//"樱桃小丸子",
"威吓":	"a2_42.png",//"时崎狂三",
"jojo立":	"a2_37.png",//"仗助",
"jojo立2":	"a2_38.png",//"承太郎",
"jojo立3":	"a2_39.png",//"乔斯达",
"jojo立4":	"a2_41.png",//"迪奥",
"jojo立5":	"a2_40.png"//"卡兹"

},

pst:{

"举手":	"pt00.png",
"亲":	"pt01.png",
"偷笑":	"pt02.png",
"偷笑2":	"pt03.png",
"偷笑3":	"pt04.png",
"傻眼":	"pt05.png",
"傻眼2":	"pt06.png",
"兔子":	"pt07.png",
"发光":	"pt08.png",
"呆":	"pt09.png",
"呆2":	"pt10.png",
"呆3":	"pt11.png",
"呕":	"pt12.png",
"呵欠":	"pt13.png",
"哭":	"pt14.png",
"哭2":	"pt15.png",
"哭3":	"pt16.png",
"嘲笑":	"pt17.png",
"基":	"pt18.png",
"宅":	"pt19.png",
"安慰":	"pt20.png",
"幸福":	"pt21.png",
"开心":	"pt22.png",
"开心2":	"pt23.png",
"开心3":	"pt24.png",
"怀疑":	"pt25.png",
"怒":	"pt26.png",
"怒2":	"pt27.png",
"怨":	"pt28.png",
"惊吓":	"pt29.png",
"惊吓2":	"pt30.png",
"惊呆":	"pt31.png",
"惊呆2":	"pt32.png",
"惊呆3":	"pt33.png",
"惨":	"pt34.png",
"斜眼":	"pt35.png",
"晕":	"pt36.png",
"汗":	"pt37.png",
"泪":	"pt38.png",
"泪2":	"pt39.png",
"泪3":	"pt40.png",
"泪4":	"pt41.png",
"满足":	"pt42.png",
"满足2":	"pt43.png",
"火星":	"pt44.png",
"牙疼":	"pt45.png",
"电击":	"pt46.png",
"看戏":	"pt47.png",
"眼袋":	"pt48.png",
"眼镜":	"pt49.png",
"笑而不语":	"pt50.png",
"紧张":	"pt51.png",
"美味":	"pt52.png",
"背":	"pt53.png",
"脸红":	"pt54.png",
"脸红2":	"pt55.png",
"腐":	"pt56.png",
"星星眼":	"pt57.png",
"谢":	"pt58.png",
"醉":	"pt59.png",
"闷":	"pt60.png",
"闷2":	"pt61.png",
"音乐":	"pt62.png",
"黑脸":	"pt63.png",
"鼻血":	"pt64.png"
},

dt:{
"ROLL":"dt01.png",
"上":"dt02.png",
"傲娇":"dt03.png",
"叉出去":"dt04.png",
"发光":"dt05.png",
"呵欠":"dt06.png",
"哭":"dt07.png",
"啃古头":"dt08.png",
"嘲笑":"dt09.png",
"心":"dt10.png",
"怒":"dt11.png",
"怒2":"dt12.png",
"怨":"dt13.png",
"惊":"dt14.png",
"惊2":"dt15.png",
"无语":"dt16.png",
"星星眼":"dt17.png",
"星星眼2":"dt18.png",
"晕":"dt19.png",
"注意":"dt20.png",
"注意2":"dt21.png",
"泪":"dt22.png",
"泪2":"dt23.png",
"烧":"dt24.png",
"笑":"dt25.png",
"笑2":"dt26.png",
"笑3":"dt27.png",
"脸红":"dt28.png",
"药":"dt29.png",
"衰":"dt30.png",
"鄙视":"dt31.png",
"闲":"dt32.png",
"黑脸":"dt33.png"
},

pg:{
"战斗力":"pg01.png",
"哈啤":"pg02.png",
"满分":"pg03.png",
"衰":"pg04.png",
"拒绝":"pg05.png",
"心":"pg06.png",
"严肃":"pg07.png",
"吃瓜":"pg08.png",
"嘣":"pg09.png",
"嘣2":"pg10.png",
"冻":"pg11.png",
"谢":"pg12.png",
"哭":"pg13.png",
"响指":"pg14.png",
"转身":"pg15.png"
}
		  
}//s


;(function(){
var d1 = function(){
	return (window.__CURRENT_FID==570) ? 1 : -2
	}
//1未知 2可信
ubbcode.checkLinkTable = {
'ngacn.cc':{_:2,'bbs.ngacn.cc':3},// _ 指无更多前缀的域名 2为保持原链接 3为替换成当前host
'nga.cn':{_:2,'bbs.nga.cn':3},
'donews.com':{_:2,'nga.donews.com':{_:3,'img.nga.donews.com':2,'img4.nga.donews.com':2}},
'bigccq.cn':{_:4,'bbs.bigccq.cn':4},
'178.com':{_:2,'nga.178.com':{_:3,'img.nga.178.com':2,'img4.nga.178.com':2},'club.178.com':3,'wb.178.com':-2},
'ngacn.com':{_:4,'bbs.ngacn.com':4},
_:1,
'worldofwarcraft.com':2,
'ofcard.com':2,
'uusee.com':2,
'youtube.com':2,
'youku.com':2,
'weplay.cn':2,
'tudou.com':2,
'uencn.com':2,
'sc2.cc':2,
'wowchina.com':2,
'microsoft.com':2,
'dmzj.com':2,
'com.cn':{_:1,'sina.com.cn':2},
'pixiv.net':{_:1,'embed.pixiv.net':2},
'loli.my':{_:1,'static.loli.my':2},//bilibili视频
'hdslb.com':2, //bilibili视频
'plures.net':{_:1,'r.plures.net':2},//v.longzhu.com视频
'bilibili.us':2,
'bilibili.com':2,
'bilibili.tv':2,
'66play.com':2,
'acg.tv':2,
'acfun.com':2,//acfun视频
'acfun.cn':2,
'acfun.tv':2,//acfun视频
'173.com':2,
'aixifan.com':{_:1,'cdn.aixifan.com':2},//acfun视频
'pdim.gs':{_:1,'s3.pdim.gs':2},//熊猫TV
'huomaotv.cn':{_:1,'www.huomaotv.cn':2},//熊猫TV
'letv.com':2,
'qq.com':{_:2,'jq.qq.com':-2},
'766.com':2,
'iqiyi.com':2,
'qiyi.com':2,
'pptv.com':2,
'feixiong.tv':2,
'163.com':2, //网易视频
'126.net':2, //网易视频
'netease.com':{_:1,'cc.netease.com':{_:1,'res.cc.netease.com':2}}, //网易视频
'douyu.tv':2, // 斗鱼
'douyutv.com':2, // 斗鱼
'douyucdn.cn':2,
'douyu.com':2, 
'zhanqi.tv':2, // 
'bogou.tv':2, // 播狗
'steampowered.com':2,
'www.iyingdi.cn':-2,
'2zhk.com':d1,
't.cn':d1,
'sina.lt':d1,
'url.cn':d1,
't.co':d1,
'goo.gl':d1,
'hiurl.me':d1,
'dwz.cn':d1,
'985.so':d1,
'980.so':d1,
'9.cn':d1,
'qyub.cn':d1,
'ppt.cc':d1,
'qr.net':d1,
'tinyurl.com':d1,
'bocaidj.com':d1,
'bit.ly':d1,
'xici800.cn':d1,
'jiaoyimao.com':d1,
'suo.im':d1,
'hupu.com':function(u){
	return (window.__CURRENT_FID==-81981 || window.__CURRENT_FID==485 || window.__CURRENT_FID==-7) ? 1 : -2
	},
'taobao.com':function(u){
	if(u.url.match(/coupon\.|taoquan\.|click\.|activity_id/))
		return d1(u)
	else
		return 1
	}
}
})();

ubbcode.checkIframeTable = {
'wow.178.com/':2,
'challonge.com/':2,
'music.163.com':function(u){
	var m = u.match(/height=(\d+)/i)
	return [u.replace(/(\W)auto=.+?(\W|$)/i,'$1$2'), m[1]>=90?330:298, (m[1]|0)+20]//[url,width,height]
	}
}

ubbcode.checkSigImg=function(u){
if((u+'').match(/^https?:\/\/(pic\d*\.178\.com|img\d*\.nga\.cn|img\d*\.nga\.178\.com|img\d*\.ngacn\.cc|card\.psnprofiles\.com|card\.exophase\.com|steamsignature\.com\/card)/))
	return 1
}//

ubbcode.regexplock = 0
ubbcode.videonum = 0
ubbcode.ifCanvas = window.CanvasRenderingContext2D ? true : false
ubbcode.bbscodeConvArgsSave = {}
ubbcode.contentQuoteCache = {}

ubbcode.secureText=function(txt)
{
return txt.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/\$/g,'&#36;').replace(/\x5C/g,'&#92;').replace(/&lt;br *\/?&gt;/gi,'<br />');
}
//fe

ubbcode.unSecureText = function(txt,br){
if(br)
	txt = txt.replace(/<br *\/?>/ig,"\r\n")
return txt.replace(/&nbsp;/g,' ').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&#92;/g,"\\").replace(/&#36;/g,"$").replace(/&amp;/g,"&")
}//fe

ubbcode.randDigi = function(p,l){
return p+Math.floor(Math.random()*l)
}//fe


;(function(){
var mwo = {
arg:null,
s:undefined,
v:function(){
if(this.s!==undefined)
	return this.s
if(this.arg.c){
	var p = this.arg.c
	for(var i=0;i<4;i++){
		if(p){
			if(p.nodeName=='TD' || p.nodeName=='DIV' || p.clientWidth)
				return this.s = p.clientWidth-parseInt(commonui.getStyle(p,'paddingLeft'))-parseInt(commonui.getStyle(p,'paddingRight'))-1//防止四舍五入
			else
				p=p.parentNode
			}
		else
			break
		}
	}
return this.s=0
}
}//mwo
mwo.valueOf = mwo.toString =function(){return this.v()},
ubbcode._argMaxWidth = function(x//同ubbcode.bbsCode
){
var o = function(y){this.arg=y}
o.prototype = mwo
return new o(x)
}//f
})();

/*
var arg = {
	i:123, 帖子的楼层 0开始 贴条为-1 非帖子时没有
	tId
	pId
	opt &1解析style &2在fixsize的折叠或随机块中(自动设置) &4fixsize限高 &8在快速阅读的弹出窗口中 &16在置顶中 &32在较长的置顶中 &64同isBlock(自动设置) &128在签名中 &256渲染完成后发生长宽变化需调用onResize
	authorId
	c 要解析内容的元素
	txt 或者要解析的文字
			注意文字中遇到换行'\n'时意为bbscode分段 所有已开始的tag应被强制结束
	noImg &1显示较少/小的图 &2不显示图 &524288在&1且是附件时使用小缩略图
	tId
	pId
	authorId
	rvrc 无用
	isSig 是签名
	callBack 解析完成后的callback
	isLesser 无用
	isNukePost 1是被处罚的帖子 2作者在主题中被处罚
	isNukePostAdd 辅助
	prefix 内容的前后缀
	suffix 内容的前后缀
	seedOffset 随机数代码所使用种子的偏移量
	collapseAttach 折叠附件列表
	isBlock 是折叠或随机块中(自动设置)
	collapseBlock 折叠块内容
	randomBlock 随机块内容
	maxLength 内容最大长度
	fullLink 在末尾加链接 如果是帖子的话
	removeQuote 去掉开头的引用内容
	}
*/
ubbcode.bbsCode=function(arg){
if(this.noBBCode)
	return
if (this.regexplock){
	var self = this
	return window.setTimeout(function(){self.bbsCode(arg)},50);
	}

this.regexplock = 1;
if(typeof(arg.c)=='string')arg.c=document.getElementById(arg.c)

if(!arg.maxWidth)//获取可用的宽度
	arg.maxWidth = this._argMaxWidth(arg)

arg.tId = parseInt(arg.tId,10)
if(!arg.tId)arg.tId=0
arg.pId = parseInt(arg.pId,10)
if(!arg.pId)arg.pId=0
arg.authorId = parseInt(arg.authorId,10)
if(!arg.authorId)arg.authorId=0
var argsId = (arg.c && arg.c.id) ? arg.c.id : this.randDigi('bbcode', 10000)
arg.argsId = argsId
if((arg.opt&128)==0){
	var x = arg.txt!==undefined ? arg.txt : arg.c.innerHTML
	if(x.indexOf('[quote]')!=-1)
		x = x.replace(/\[quote\](.+?)\[\/quote\](?:<br\/?>)*/gi,'')
	if(x.indexOf('Reply to [pid=')!=-1)
		x = x.replace(/^\[b\]Reply to \[pid=\d+,\d+,\d+\]Reply\[\/pid\] Post by .+?\[\/b\](?:<br\/?>)*/gi,'')
	this.contentQuoteCache[arg.pId] = x.substr(0,250).replace(/<[^>]+$/,'')
	}

if(arg.onResizeQue===undefined){//子继承母块的队列时不需新建
	arg.onResizeQue = []//size change handler in this
	arg.onResize = ubbcode.onResizeProto//call this when size change
	}

this.bbscodeConvArgsSave[argsId]=arg

if(arg.i===undefined)
	arg.i = 'r'+Math.floor(Math.random()*10000)

if(!arg.prefix)arg.prefix=''
if(!arg.suffix)arg.suffix=''
arg.suffix+="<img src='about:blank' style='display:none' onerror='ubbcode.copyChk(this.parentNode,\""+arg.argsId+"\")'/>"

//if(window.__DEBUG)
		  //this.parser(arg)

if(arg.c){
	if(!arg.c.className || arg.c.className.indexOf('ubbcode')==-1)arg.c.className+=' ubbcode'
	var tmp = this.bbscode_core(arg)
	arg.c.innerHTML = tmp
	if(arg.callBack)arg.callBack(arg)
	var y=this.attach.cache['attach'+arg.i]
	if(y && !y.loaded){
		y.loaded=1
		this.attach.disp(arg.i,arg.collapseAttach?2:0)
		}
	this.regexplock = 0;
	}
else{
	var y = this.bbscode_core(arg);
	if(arg.callBack)y = arg.callBack(arg,y)
	this.regexplock = 0;
	return y
	}
	
}//fe

ubbcode.onResizeProto = function(){
if(this.onResizeQue.length){
	if(this.onResizeTimeout)
		clearTimeout(this.onResizeTimeout)
	var j = this
	this.onResizeTimeout=setTimeout(function(){
		var i = j.onResizeQue.length
		while(i--)
			j.onResizeQue[i].call(j)
		},50)
	}
}//

ubbcode.manualLoadCache = {}

ubbcode.bbscode_core=function(arg)
{
if(!arg.txt)arg.txt = arg.c.innerHTML
//if(!arg.noCov)
//	arg.txt = arg.txt.replace(/<br\s*\/>/g,'\x01')
if(this.bbscode_pre)
	this.bbscode_pre(arg)

//ubbcode.parser(arg)

this.lesserNuke(arg)

if(arg.removeQuote){
	arg.txt = arg.txt.replace(/\s*\[quote\]\[pid=188165576,9591866,2\]Reply\[\/pid\] \[b\]Post by .+?\[\/quote\]/g,function($0){
		 return ''
		 })
	}

if(arg.maxLength && arg.txt.length > arg.maxLength){
	arg.txt = arg.txt.substr(0,arg.maxLength)+'……'
	if(arg.tId)
		arg.suffix+=" <a href='/read.php?tid="+arg.tId+(arg.pId?'&pid='+arg.pId+'&to=1':'')+"' target='_blank' class='silver'>[全部]</a>"
	}
else if(arg.fullLink)
	arg.suffix+="…… <a href='/read.php?tid="+arg.tId+(arg.pId?'&pid='+arg.pId+'&to=1':'')+"' target='_blank' class='silver'>[原帖]</a>"

if (arg.txt.match(/[\[=&]/)==null){
	this.contentPrefix(arg)
	return arg.txt
	}

arg.txt = arg.txt.replace(/\n/g,' ');
if(!arg.noCov)
	arg.txt = this.secureText(arg.txt)

this.codeTag.parse(arg)

if(this.bbscode_bef)
	this.bbscode_bef(arg)

this.collapse.parse(arg)

arg.txt = arg.txt.replace(/&amp;#(\d{2,8});/g,function($0,$1){
    if(($1>127 && $1<19968) || $1>40869)
        return  String.fromCharCode($1)
    else
        return  $0
    })
	 
if(this.bbscode_mid)
	this.bbscode_mid(arg)

this.bbscode_common(arg)

if(this.bbscode_aft)
	this.bbscode_aft(arg)

if(this.collapse.had && arg.txt.indexOf('[collapse')!=-1)
	arg.txt = arg.txt.replace(/\[collapse(=[^\]]{1,50})?\].+\n/,"<span style='text-decoration:line-through' class='gray'>&nbsp;被折叠的内容&nbsp;</span>")

this.contentPrefix(arg)
//if(!arg.noCov)
//	arg.txt = arg.txt.replace(/\x01/,'<br/>')
return arg.txt;
}//fe

ubbcode.bbscode_common=function(arg)
{

var wo = window, commonui=wo.commonui, self = this, argsId = arg.argsId, noimg = (arg.noImg|0)|((wo.__SETTING.bit & 64)?1:0)|((wo.__SETTING.bit & 524288)?524288:0)

if(arg.txt.indexOf('[urlreplace')!=-1){
arg.txt = arg.txt.replace(/\[urlreplace\](?:\[url\])?(.+?)(?:\[\/url\])?\[\/urlreplace\]/g,function($0,$1){
	if(!arg.urlReplace)arg.urlReplace=[]
	arg.urlReplace.push($1)
	return ''
	})
}//if

arg.txt = arg.txt.replace(/^(?:\[b\])?Reply to \[(pid|tid)=([,\d]+)\](?:Reply|Topic)\[\/(?:pid|tid)\] Post by (.+?\[\/uid\] \(\d+-\d+-\d+ \d+:\d+\):?)(?:\[\/b\])?\s*(<br \/>)*/gi,function($0,$1,$2,$3,$4){
if(arg.isComment)
	return "<span class='x'>"+$0+'</span>'
var i = $2.split(',')[0],z=self.contentQuoteCache
if(!z[i])
	return $0+($4?'':'<br/>')
/*
if(z[i].charAt(z[i].length-1)!='\n'){
	var x=0,y=0
	z[i].replace(/\[\/?quote\]/,function($0){$0.charAt(1)=='/'?y++:x++;return $0})
	while(x>y){
		z[i]+='[/quote]'
		y++
		}
	while(x<y){
		z[i]='[quote]'+z[i]
		x++
		}
	z[i]+='\n'
	}*/
return '[quote]['+$1+'='+$2+']Reply[/pid] Post by '+$3+':<br/><br/>\n'+z[i]+'\n[/quote]<br/>'//加换行防止半个bbscode
})

if(arg.txt.indexOf('[crypt')!=-1){
arg.txt = arg.txt .replace(/\[crypt\](.+?)\[\/crypt\]/gi,function($0,$1){
	var id = self.randDigi('crypt', 10000)
	self.decryptCache[id] = $1;
	return "<div class='quote'><b>输入正确的密码以浏览加密的内容 </b><input type=text size=10><button type='button' onclick='ubbcode.decrypt(this.previousSibling.value,ubbcode.decryptCache[\""+id+"\"],this.parentNode,\""+argsId+"\")'>确认</button></div>"
	})
}//if
/*
if(arg.txt.indexOf('&gt;')+1)
	arg.txt = arg.txt.replace(/((?:<br \/>)|^)&gt;(.+?)((?:<br \/>\s*<br \/>)|$)/gi,function($0,$1,$2,$3){
		if($2.match(/\[\/quote\]/))
			return $0
		return $1+'[quote]'+$2.replace(/<br \/>&gt;/,'<br />')+'[/quote]'+$3
		})
*/
this.parseQuote.parse(arg)

//简化引用格式
arg.txt = arg.txt.replace(/(?:\[b\])?(Reply to )?(\[(?:t|p)id=[\d,\-]+\](?:Reply|Topic)\[\/(?:t|p)id\]) (?:\[b\])?Post by (\[uid=\d+\].+?\[\/uid\]) (\(\d+-\d+-\d+ \d+:\d+\)):?(?:\[\/b\])?/g,function($0,$1,$2,$3,$4){return ($1?$1:'')+$2+" by "+$3+"<span class='xtxt silver' style='font-weight:normal'>"+$4+"</span>"})

if(arg.txt.indexOf('[table')!=-1)
	this.parseTable(arg)

this.ubi.parse(arg);//[del][u][b][i][sup][sub]



arg.txt = arg.txt.replace(/\[dice\]([\dd+\s]+?)\[\/dice\]/gi,function($0,$1){
var sum = 0;
var rr = $1;
$1 = '+'+$1;
$1 = $1.replace(/(\+)(\d{0,10})(?:(d)(\d{1,10}))?/gi,function($0,$1,$2,$3,$4){
	if($2)$2 = parseInt($2,10); else if($3)$2=1; else $2=0;
	$4 = parseInt($4,10);
	var r = '';
	if(!$3){if(typeof(sum)!='string')sum+=$2;return '+'+$2}
	if($2>10 || $4>100000){sum='ERROR';return'+OUT OF LIMIT'};
	for (var i=0; i<$2; i++)
		{
		var rand = Math.floor(self.sRand.rnd(argsId)*$4)+1
		r+='+d'+$4+'('+rand+')';
		if(typeof(sum)!='string')sum+=rand;
		}
	return r;
	});
return "<table class='dice'><tr><td><b>ROLL : "+rr+'</b>='+$1.substr(1)+'=<b>'+sum+"</b></td></tr></table>";
});//[dice]
		
ubbcode.parseList.parse(arg)//[list]
/*
var tmp = 0
arg.txt = arg.txt.replace(/\[(?:\/?)color(?:\d?)(?:=(bg)?(skyblue|royalblue|blue|darkblue|orange|orangered|crimson|red|firebrick|darkred|green|limegreen|seagreen|teal|deeppink|tomato|coral|purple|indigo|burlywood|sandybrown|sienna|chocolate|silver|gray))?\]/gi,function($0,$1,$2){
	if(tmp<0)
		return $0
	if($0.charAt(1)=='/'){
		tmp--
		if(tmp<0)
			return $0
		return "</span>"
		}
	else{
		tmp++
		if($1)
			return "<span class='small_colored_text_btn white' style='font-family:inherit;background-color:"+$2+"'>"
		else
			return "<span class='"+$2+"'>"
		}
	});//[color]
	
if(tmp>0){
	while((tmp--)>0)
		arg.txt+="</span><!--[color]error-->"
	}
	*/

//c = c.replace(/\[email\](.+?)\[\/email\]/gi,"<a href='mailto:$1'>$1</a>");//[email\]
/*
arg.txt = arg.txt.replace(/\[upup\](.+?)\[\/upup\]/i,function($0,$1){
	if(self.ifCanvas && $1.length<8 && $1.indexOf('[')==-1 && $1.indexOf('<')==-1)
		return ' <b>'+$1+"</b><img src='about:blank' style='display:none' onerror='ubbcode.upupProc(this.previousSibling)'/> "
	else
		return ' <b>'+$1+"</b> "
	});//[upup]
*/
//arg.txt = arg.txt.replace(/\[size=(\d{1,3})%?\](.*?)\[\/size\]/gi,function($0,$1,$2){return "<span style='font-size:"+$1+"%;line-height:183%'>"+$2+"</span>"});//[size\]

//arg.txt = arg.txt.replace(/\[font=(simsun|simhei|Arial|Arial Black|Book Antiqua|Century Gothic|Comic Sans MS|Courier New|Georgia|Impact|Tahoma|Times New Roman|Trebuchet MS|Script MT Bold|Stencil|Verdana|Lucida Console)\](.+?)\[\/font\]/gi,"<span style='font-family:$1'>$2</span>");//[font]
/*
arg.txt = arg.txt.replace(/(?:<br\s*\/?>)?\s*\[align=(left|center|right)\](.+?)\[\/align\]\s*(?:<br\s*\/?>)?/gi,
	function($0,$1,$2){
		return "<div class='ta"+$1.substr(0,1)+"' style='text-align:"+$1+"'>"+$2.replace(/^<br\s*\/?>|<br\s*\/?>$/g,'')+"</div>"
		});//[align]
*/
if(arg.txt.indexOf('[headline]')!=-1)
	this.parseHeadline(arg)

if(arg.txt.indexOf('[album')!=-1){
	arg.txt = arg.txt.replace(/\[album=?([^\]]{0,50})\](.+?)\[\/album\]/gi,function ($0,$1,$2){
		var img=[]
		if ($2.match(/\[(?:img|url)\]/i))
			$2.replace(/\]\s*((?:(?:https?:\/\/)|(?:\.\/))[^\[]+)\s*\[/ig,function ($0,$1){if($1.substr(0,2)=='./')$1=commonui.getAttachBase($1)+'/'+$1.substr(2);img.push($1)})
		else
			$2.replace(/(?:^|[^a-zA-Z0-9\-_\+=\.\$;\/\?:@&=#%])((?:https?:\/\/|\.\/)[a-zA-Z0-9\-_\+=\.\$;\/\?:@&=#%]+)/ig,function($0,$1){if($1.substr(0,2)=='./')$1=commonui.getAttachBase($1)+'/'+$1.substr(2);img.push($1)})
		if (img[0]){
			var a = img[0]
			if (a && a.substr(0,2)=='./')
				a = commonui.getAttachBase(a)+'/'+a.substr(2);
			if (commonui.ifUrlAttach(a) && a.substr(a.length-10)!='.thumb.jpg')
				a+='.thumb.jpg'
			if (!$1)
				$1='查看相册'
			//var arg = self.bbscodeConvArgsSave[argsId]
			var tid = parseInt(arg.tId,10)
			var pid = parseInt(arg.pId,10)
			var id = self.album.albumCount++
			if(!tid)tid=0
			if(!pid)pid=0
			self.album.cache[id]={album:img,title:$1,tid:tid,pid:pid,id:id}
			return "<table class='quote album'><tr><td><a href='./nuke/album.html?uid="+__CURRENT_UID+"&tid="+tid+"&pid="+pid+"&id="+id+"&a' target='_blank' onclick='ubbcode.album.open(\""+id+
				"\")'>"+$1+"<br/><img src='about:blank' onerror='"+(noimg?'':"ubbcode.album.imgLoad(this,\""+a+"\")")+"' style='display:none'/><br/>共"+img.length+"张图片 点击查看全部</a></td></tr></table>"
			}
		return "[album="+$1+"]"+$2+"[/album]"
		});//[album\]
	}//if


this.imgGen.c=0
arg.txt = arg.txt.replace(/\[img(-?\d{0,3})\](.+?)\[\/img\]/gi,function($0,$1,$2){
	return self.imgGen($1,$2,noimg,arg)
	})

if(arg.txt.indexOf('[flash')!=-1)
	this.parseFlash(arg)

if(arg.txt.indexOf('[iframe')!=-1){
	arg.txt = arg.txt.replace(/\[iframe(?:=(\d+)(?:,(\d+))?)?\](https?:\/\/)(.+?)\[\/iframe\]/gi,function($0,$1,$2,$3,$4){
		$1 = $1|0
		$2 = $2|0
		if(location.protocol=='https:')$3='https://'
		var u = self.urlToAry($3+$4),x=$0,y=self.checkIframeTable[u.host]
		if(y){
			if(y.constructor==Function){
				u=y(u.url)
				if(!$2)$2=u[1]
				if(!$1)$1=u[2]
				u=u[0]
				}
			$2 = (!$2 || $2>1000)? '100%' : $2+'px'
			$1 = (!$1 || $1>2000)? 500+'px' : $1+'px'
			x= "<div><div style='font-size:8px;line-height:10px;height:10px;overflow:hidden'>IFRAME:"+u+"</div><iframe frameborder=0 marginheight=0 marginwidth=0 scrolling='no' style='box-sizing:border-box;border:1px solid #444;width:"+$2+";height:"+$1+";overflow:hidden;margin:0;background:transparent' src='"+u+"'></iframe></div>"
			}

		if (noimg){
			var id = self.randDigi('manualLoadFrame', 10000)
			self.manualLoadCache[id]=x
			return "<button type='button' onclick='this.nextSibling.innerHTML=ubbcode.manualLoadCache[\""+id+"\"];this.nextSibling.style.display=\"\";this.style.display=\"none\"'>点击显示页面</button><span style='display:none'></span>"
			}
		else
			return x
		});//[iframe]
	}//if


arg.txt = arg.txt.replace(/\[s:(.{1,10}?)\]/gi,function($0,$1){

	if(parseInt($1,10)){
		var x = __IMGPATH+'/post/smile/'+self.smiles[0][$1] , y = "S"+$1, z =''
		}
	else{
		$1 = $1.split(':')
		var x=self.smiles[$1[0]]
		if(!x)return $0
		if(!$1[1] || !x[$1[1]])
			return $0
		var x = __IMGPATH+'/post/smile/'+x[$1[1]] , y = $1[1], z='_'+$1[0]
		}

	if(noimg&2)//小图片只有在调用指定时不显示
		return "<button alt='"+x+"' onclick='var tmp = _$(\"/img\").$0(\"className\",\"smile"+z+"\",\"src\",\""+x+"\");this.parentNode.replaceChild(tmp,this)'/>"+y+"</button>"
	else
		return "<img class='smile"+z+"' src='"+x+"' alt='"+y+"'/>"
	} );//[smile]



arg.txt = arg.txt.replace(/\[attach\](.+?)\[\/attach\]/gi,function($0,$1){
	if ($1 && $1.substr(0,2).toLowerCase()=='./')
		$1 = commonui.getAttachBase($1)+'/'+$1.substr(2);
	if (commonui.ifUrlAttach($1))
		//var uu = self.urlToAry($1),x=self.mediaBlk(arg,uu)
		//if(x)
			//return x
		return self.writelink($1)
	return $0
	});



arg.txt = arg.txt.replace(/\[url(=[^\[\]]+?)?\](.+?)\[\/url\]/gi,function($0,$1,$2){if($1) return self.writelink($1.substr(1),$2); else return self.writelink($2)});//[url]

arg.txt = arg.txt.replace(/\[(tid|pid|stid)=?([\d,]{0,50})\](.+?)\[\/\1\]/gi,function($0,$1,$2,$3){
	return self.postLinkTag($1,$2,$3,arg.opt & 8)
	})

arg.txt = arg.txt.replace(/\[uid=?(\d{0,50})\](.+?)\[\/uid\]/gi,function($0,$1,$2){
	if(commonui.htmlName){
		$2 = commonui.htmlName($2)
		if(!$2)return $0
		if(parseInt($1,10))
			return " <a href='/nuke.php?func=ucp&uid="+$1+"' class='b'>["+$2+"]</a> "
		else
			return " <b>["+$2+"]</b>";
		}
	if(parseInt($1,10))
		return " <a href='/nuke.php?func=ucp&uid="+$1+"' class='b'>["+$2+"]</a> "
	else if(!$1 && $2.match(/anony_[a-f0-9]{32}/))
		return " <b>["+commonui.anonyName($2,true)+"]</b>";
	})

arg.txt = arg.txt.replace(/\[@(.{2,20}?)\]/gi,function($0,$1){
	var i
	return" <a href='/nuke.php?func=ucp&__inchst=UTF-8&"+((i=$1.match(/^(?:UID)?(\d+)$/i)) ? "uid="+i[1] : "username="+encodeURIComponent($1))+"' class='b'>"+$0+"</a> " 
	} );//[@]

var tmp=0
arg.txt = arg.txt.replace(/\s*\[h\](.*?)\[\/h\]\s*(?:<br \/>)?/gi,function($0,$1){
	if(!$1)tmp++
	return "<h4 class='subtitle'"+($1?'':" style='line-height:0;font-size:0;padding:0;margin:0 0 3px 0;height:0'")+">"+$1+"</h4>"
	});//[h]

arg.txt = arg.txt.replace(/(<br \/>|>|\]|^)\s*(?:(=|-){3})(.{0,100}?)(?:\2{3,})\s*(<br \/>|<|\[|$)/gi, function($0,$1,$2,$3,$4){
	if($3.indexOf('<br />')!=-1)
		return $0
	$3 = $3.replace(new RegExp('^'+$2+'+|'+$2+'+$','g'),'')
	if($3=='')tmp++
	return $1+"<h"+($2=='='?4:5)+" class='subtitle'"+($3==''?" style='line-height:0;font-size:0;padding:0;margin:0 0 3px 0;height:0'":'')+">"+$3+"</h"+($2=='='?4:5)+">"+($4=='<br \/>' ? '' : $4)
	})
	/*
if(tmp)
	arg.txt = arg.txt.replace(/(.{1,50}?)<h(4|5)[^>]+><\/h\2>/gi, function($0,$1,$2){
		console.log($1)
		if($1.match(/[<>\[\]]/))
			return $0
		$1 = $1.split('<br />')
		if($1.length==1)
			return $0
		var x = $1.pop()
		if(x.match(/^\s*$/))
			x = $1.pop()
		if(x.match(/^\s*$/))
			return $0
		if($1[$1.length-1].match(/^\s*$/))
			return $1.join('<br />')+"<h"+$2+" class='subtitle'>"+x+"</h"+$2+">"
		return $0
		})
	*/
/*
arg.txt = arg.txt.replace(/(?:<br\s*\/?>)?\s*(={3,100})([\u0000-\uffff]{0,100}?)(={3,100}|<br\s*\/?>|$)\s*(?:<br\s*\/?>)?/gi,
	function($0,$1,$2,$3){
		if($3=='' || $3.substr(0,1)=='<'){
			if($1.length<6 || ($2 != '' && !$2.match(/^\s+$/)))
				return $0
			return "<h4 class='subtitle'></h4>";
			}
		else
			return "<h4 class='subtitle'>"+$2+"</h4>";
		});//[h]
*/
arg.txt = arg.txt.replace(/\[chartradar (\d+) (\d+) (\d+) (\d+) (#[a-fA-F0-9]{6})\](.+)\[\/chartradar\]/gi,
	function($0,$1,$2,$3,$4,$5,$6){
		var x = {
			w:$1<400 && $1>0 ? $1|0 : 400,//宽
			h:$2<200 && $2>0 ? $2|0 : 200,//高
			tc:$5,//文字颜色
			ts:12,//文字大小
			tf:'Microsoft Yahei,Verdana, Tahoma, Arial, sans-serif',//字体
			gn:$3<11 && $3>0 ? $3|0 : 10,//刻度线数量
			gc:'silver',//刻度线颜色
			gw:0.5,//刻度线宽度
			sc:$5,//数据线颜色
			sw:2,//数据线宽度
			offset:$4>0 && $4<360 ? $4|0 : 0,//偏转角度
			length:0
			}

		x.x = x.w/2//中心位置
		x.y = x.h/2
		x.r = x.h/2-x.ts*2//半径
		
		$6 = $6.split(/\s+/g)
		
		var j = $6.length<22 ? $6.length : 21
		if(($6[0]|0)<1)$6[0] = 100
		for(var i=1;i<j;i+=2){
			if(($6[i]=$6[i]|0) && ($6[i+1]=$6[i+1].replace(/^\s+|\s+$/g,'')))
				x[x.length++] = [Math.abs($6[i])/$6[0]*x.r, $6[i+1].substr(0,10), $6[i]]
			}

		return self.drawChartRadar(x)
		});//[h]
/*
arg.txt = arg.txt.replace(/(?:<br \/>)?\s*\[(l|r)(\s[^\[\]]+)?\]\s*(?:<br \/>)?\s*(.+?)\s*(?:<br \/>)?\s*\[\/\1\]\s*(?:<br \/>)?/gi,function($0,$1,$2,$3){
	if($2){
		$2 = $2.replace(/^\s+/,'').split(/\s+/)

		var i=0,j
		while(i<2){
			if(j= parseInt($2[i],10)){
				if($2[i].substr($2[i].length-2)=='em')
					$2[i] = j+'em'
				else
					$2[i] = (j-0.05)+'%'
				}
			else
				$2[i] = 0
			i++
			}
		if($2[0]){
			if($2[1])
				$2="style='overflow:hidden;min-width:"+$2[0]+";max-width:"+$2[1]+"'"
			else
				$2="style='overflow:hidden;width:"+$2[0]
			}
		else
			$2=''
		}
	if($1=='l')
		$1='left'
	else
		$1='right'
	return "<div "+$2+" class='"+$1+"'>"+$3+"</div>"
	});//[left][right]
*/
//if(arg.txt.indexOf('[t.178.com')!=-1)
//	this.parseT178(arg)

if(arg.isBlock && arg.opt && (arg.opt&1))
	this.parseFix(arg)

if(arg.txt.length>24)//常见符号连续25个加空格
	arg.txt = arg.txt.replace(/([\xb7\x7e\x40\x23\x25\x26\x2a\x2b\x7c\x2d\x3d\x60\x7e\x21\x40\x23\x24\x25\x5e\x26\x2a\x28\x29\x5f\x2b\x7b\x7d\x7c\x3a\x22\x3c\x3e\x3f\x2d\x3d\x5b\x5d\x5c\x3b\x27\x2c\x2e\x2f\uff01\uffe5\u2026\u2026\uff08\uff09\u2014\u2014\uff5b\uff5d\uff1a\u201c\uff1f\u300b\u300a\u3010\u3011\u3001\uff1b\u2018\uff0c\u3002\u3001])\1{24,}/g,function($0){
		var x=''
		for(var i=0;i<$0.length;i++)
			x += $0.charAt(i)+'\u200b'//0宽空格以自动换行
		return x
		})
}//fe
//=============================
//table
//=============================
;(function(){
var table,tr,td,noboder,align,width,colspan,rowspan,space

function init(){
table=/(?:<br \/>\s*)?\[table\s*([^\]]*)\](.+?)\[\/table\]\s*(?:<br \/>)?/gi
tr=/(?:<br \/>\s*)?\[tr\](.+?)\[\/tr\]\s*(?:<br \/>)?/gi
td=/(?:<br \/>\s*)?\[td\s*([^\]]*)\](.*?)\[\/td\]\s*(?:<br \/>)?/gi
noboder=/noborder/
align=/top/g
width=/width=?(auto|\d{0,2})/
width=/width=?(auto|\d{0,2})/
colspan=/colspan=?(\d{0,2})/
rowspan=/rowspan=?(\d{0,2})/
space=/^(?:<br \/>|\s)+|(?:<br \/>|\s)+$/g
}
ubbcode.parseTable=function(arg){
if(table===undefined)
	init()
arg.txt = arg.txt.replace(table,function ($0,$1,$2){
	var t = $2.replace(space,''),y,z="'",b=1,d='',m,bc=__COLOR.border3
	//if ($1.match(noboder))
		//b=0
	
	t = t.replace(tr,function($0,$1){return '<tr>'+$1.replace(space,'')+'</tr>'});//[tr]
	t = t.replace(td,function($0,$1,$2){
		var x,w="'"
		if (x = parseFloat($1)){
			if(x<100)
				w = 'width:'+x+'%;'+w
			}
		else{
			if (x = $1.match(width))
				w='width:'+x[1]+(x[1]=='auto'?';':'%;')+w
			if (x = $1.match(colspan))
				w+=' colspan='+x[1]
			if (x = $1.match(rowspan))
				w+=' rowspan='+x[1]
			if (x = $1.match(align)){
				for(var i=0;i<x.length;i++)
					if(x[i]=='top')
						w='vertical-align:top;'+w
					//else if(x[i]=='justify')
					//	w='text-align:justify-all;text-align-last:justify;text-justify:inter-word;'+w
				}
			}
		return "<td style='border-left:"+b+"px solid "+bc+";border-bottom:"+b+"px solid "+bc+"; "+w+">"+$2.replace(space,'')+"</td>"
		});//[td]
	if (y = parseFloat($1)){
		if(y<=100)
			z = 'width:'+y+'%;'+z
		}
	else{
		if (y = $1.match(width))
			z='width:'+y[1]+(y[1]=='auto'?';':'%;')+z
		else
			z='width:99.95%'+z
		}
	return "<div><table cellspacing='0px' style='border:"+b+"px solid "+bc+";border-left:none;border-bottom:none;"+z+"'>"+t+"</table></div>"
	});//[table]
}//fe

})();
//=============================
ubbcode.drawChartRadar=function(x){

var y = 360 / x.length, z, p, q,
svg = "<svg width='"+x.w+"px' height='"+x.h+"px' version='1.1' xmlns='http://www.w3.org/2000/svg'>",
gpath = function(p,s,w,f){
	var t=''
	for(var i=0; i<p.length; i++){
		t+="M"+p[i][0]+' '+p[i][1]
		if(p[i+1])
			t+=" L"+p[i+1][0]+' '+p[i+1][1]+' '
		else
			t+=" L"+p[0][0]+' '+p[0][1]+' '
		}
	return "<path d='"+t+"' transform='translate("+x.x+","+x.y+")' stroke='"+s+"' stroke-width='"+w+"' fill='"+f+"'/>"
	},
deg2xy = function(deg,r){
	var rad =  deg*(Math.PI / 180)//弧度
	return [ 
		(Math.sin(rad) * r).toFixed(2), 
		-(Math.cos(rad) * r).toFixed(2)
		 ]
	}

for(var i=1; i<=x.gn; i++){
	z = x.offset,p=[]
	for(var j=0; j<x.length; j++){
		p.push(deg2xy(z,x.r/x.gn*i))
		z+=y
		}
	svg += gpath(p, x.gc, x.gw, 'none')
	}

z = x.offset,p=[]
for(var i=0; i<x.length; i++){
	p = deg2xy(z,x.r)
	svg += "<path d='M0 0 L"+p[0]+" "+p[1]+"' transform='translate("+x.x+","+x.y+")' stroke='"+x.gc+"' stroke-width='"+x.gw+"' fill='none'/>"
	z+=y
	}

z = x.offset,p=[]
for(var i=0; i<x.length; i++){
	p.push(deg2xy(z,x[i][0]))
	z+=y
	}
svg += gpath(p, x.sc, x.sw, 'none')

z = x.offset,p=[]
for(var i=0; i<x.length; i++){
	p = deg2xy(z,x.r+x.ts/2)
	svg += "<text x='"+p[0]+"' y='"+p[1]+"' style='font-family:"+x.tf+";font-size:"+x.ts+";fill:"+x.tc+";' text-anchor='"+(z>=0 && z<180 ? 'start' : 'end')+"' transform='translate("+x.x+","+(x.y+x.ts/3)+")' fill='red'>"+x[i][1]+':'+(x[i][2] ? x[i][2] : x[i][0])+"</text>"
	z+=y
	}

return svg+'</svg>'
}
//=============================
ubbcode.lesserNuke = function(arg){
var f = function(x){return "<div class='lessernuke"+(x && x!=1? " lessernuke"+x+"'><span class='sienna'>用户在主题中被处罚" : "'><span class='crimson'>用户因此贴中的发言被处罚")+"</span> <a href='javascript:void(0)' onclick='var x = document.getElementsByName(\"lessernukeblk\");for(var i=0;i<x.length;i++){x[i].style.display=\"\"}'>点击查看</a><div style='display:none' name='lessernukeblk'>";}

if(!arg.isNukePost){
	var i=0
	arg.txt = arg.txt.replace(/^\s*\[lessernuke(\d)?\]|\[\/lessernuke(\d)?\]\s*$/gi,function($0,$1){
		if($0.charAt(1)=='/')
			i++
		else
			arg.isNukePost=$1?$1:1
		return '';
		});//[lessernuke]
	}
if(arg.isNukePost && !arg.isNukePostAdd){
	arg.isNukePostAdd = 1
	arg.prefix+=f(arg.isNukePost)
	arg.suffix+='</div></div>'
	}
}//fe
//=============================

ubbcode.parseFix = function(arg){
	var fc, w, h, mw, b , bb, toF=function(x){x=parseFloat(x,10);return x ? x:0}, tg=[], self=this
		
	arg.txt = arg.txt.replace(/\x00?\[fixsize\W(.+?)\]\x00?/,function($0,$1,$2){
		var x = $1.split(/(?:,| )+/)
		for(var i=0;i<x.length;i+=2){
			var y = x[i], z=x[i+1]
			switch(y){
				case 'width':
					w = toF(z)
					if(mw = toF(x[i+2]))
						i++
					break
				case 'height':
					h = toF(z)
					break	
				case 'background':
					if(z.match(/^(#[0-9a-fA-F]{3,6}|transparent)$/))
						b = z
					if(x[i+2].match(/^(#[0-9a-fA-F]{3,6}|transparent)$/)){
						bb = x[i+2]
						i++
						}
				}
			}

		if(w && w<300 && w>0 && h && h<(arg.opt&4 ? 21 : 300) && h >0){
			fc="<div class='fixblk' id='fixblk_"+arg.argsId+"' style='clear:both;overflow:hidden;width:auto;height:"+h+"em;"+(b ? "background:"+b : 'box-shadow: inset 0 0 15px -8px #000;background:'+__COLOR.bg6)+"'><div style='margin:auto;overflow:hidden;position:relative;z-index:0;height:"+h+"em;"+((mw && mw>0 && mw<300) ? "max-width:"+mw+"em;min-width:"+w+"em;" : "width:"+w+"em;")+(bb ? "background:"+bb : '')+"'>"
			return ''
			}
		else
			return $0+"<button>过高或过宽</button>"
		})
	
	if(!fc)
		return
	arg.txt = arg.txt.replace(/\s*<br \/>/g,'\x00')
	arg.txt = arg.txt.replace(/\[\/?comment (.+?)\]/g,'')
	arg.txt = arg.txt.replace(/\[stripbr\][\x00\s]*/g,'')
	
	arg.txt = fc+arg.txt

	arg.txt = arg.txt.replace(/\x00?\[(\/?)style(?:\s([^\]]+))?\]\x00?/g,function($0,$1,$2){
		if($1)
			return tg.length ? tg.pop() : $0
			
		var x = $2.split(/(?:,| )+/),t = {},s={display:'inline-block'},u={tagName:'div',style:s}
		for(var i=0;i<x.length;i+=2){
			var y = x[i], z=x[i+1], u, w
			switch(y){
				case 'rotate':
					if(z = toF(z))
						t[y] = z+"deg"
					break
				case 'scale':
					if(z = toF(z))
						t[y] = z
					break
				case 'margin':
				case 'padding':
					var j=1
					s[y]=''
					while(j<5){
						if(x[i+j]=='auto')
							s[y] += 'auto '
						else if(!isNaN(parseFloat(x[i+j],10)))
							s[y] += x[i+j]+'em '
						else
							break
						j++
						}
					i+=j-2
					s[y] = s[y].substr(0,s[y].length-1)
					break
				case 'clear':
					if(z=='both')
						s[y]=z
				case 'float':
					if(z=='left' || z=='right')
						s[y]=z
					break
				case 'top':
				case 'right':
				case 'bottom':
				case 'left':
					s.position = 'absolute'
					s[y]=toF(z)+'em'
					break
				case 'align':
					if(z=='center' || z=='left' || z=='right')
						s['text-align']=z
					else if(z=='justify-all'){
						s['text-align']='justify'
						s['text-align-last']='justify'
						s['text-justify']='inter-word'
						}
						
					break
				/*case 'shiftX':
				case 'shiftY':
					if((z = toF(z))>0){
						if(!u.id)u.id='sub'+Math.random()
						u[y]=1+(z.charAt(z.length-1)=='%'?z/100:z)
						}
					break*/
				case 'width':
				case 'height':
				case 'border-radius':
				case 'line-height':
					if((z = toF(z))>0)
						s[y]=z+(x[i+1].charAt(x[i+1].length-1)=='%'?'%':'em')
					break
				case 'font':
					if((z = toF(z))>0)
						s['font-size']=z+'em'
					if((z=x[i+2]+'').match(/^#[0-9a-fA-F]{3,6}$/)){
						s.color = z
						i++
						}
					if((z=x[i+2])=='serif'){
						s['font-family'] = z
						i++
						}
					break;
				case 'innerHTML':
					if(z=='&#36;votedata_vote1value' || z=='&#36;votedata_usernum' || z=='&#36;votedata_voteavgvalue')
						u.innerHTML = commonui.vote && commonui.vote[z.substr(5)] ? commonui.vote[z.substr(5)] : 'N/A'
					break;
				case 'src':
					if(z.match(/^\.\/[a-zA-Z0-9_\/\.\-]+\.(?:jpg|png|svg)$/))
						u[y] = commonui.getAttachBase(z)+z.substr(1)
					break;
				case 'background':
				case 'color':
					if(z.match(/^#[0-9a-fA-F]{3,6}$/))
						s[y] = z
					break	
				case 'dybg'://背景图缩放(相对于元素)x%,背景位置x,背景位置y,(活动量水平,活动量垂直 或 活动量水平)
					if(s.width && s.height){
						var pm = z.match(/-?[\d\.]+%?/g),pb = z.match(/\.\/.+$/)
						if(pm && pb){
							for(var j=0;j<pm.length;j++)
								pm[j] = (parseFloat(pm[j])*1000<<1)|(pm[j].charAt(pm[j].length-1)=='%' ? 1:0)
							if(!pm[4])pm[4]=0
							pb = commonui.getAttachBase(pb[0])+'/'+pb[0].substr(2)
							s['background-image'] = 'url('+pb+')'
							s['background-position'] = (pm[1]>>1)/1000+(pm[1]&1?'%':'em')+' '+(pm[2]>>1)/1000+(pm[2]&1?'%':'em')
							s['transition'] = 'background-position 0.1s linear 0s';
							if(pm[0]>>1)
								s['background-size'] = (pm[0]>>1)/1000+'%'//(Math.max(pm[4],pm[3])*2)+'%'
							if(!u.onmousemove)u.onmousemove=''
							u.onmousemove += 'if(!this._gybg)this._gybg=ubbcode.parseFix.dybg;this._gybg(event,this,"'+arg.argsId+'",'+pm[1]+','+pm[2]+','+pm[3]+','+pm[4]+');'
							}
						}
					break
				case 'parentfitwidth':
					if(!u.onload)u.onload=''
					u.onload+="var x=this.parentNode;x.style.width=this.width+\"px\";x.style.height=this.height+\"px\";"
					i--
				}
			
			}

		y=z=w=v=a=b=''
		if(u.src){
			tg.push('')
			u.tagName= "img"
			}/*
		else if(s.href){
			v = self.urlToAry(s.href)
			tg.push('</a>')
			u= "a href='"+v.url+"' onmouseover='this.childNodes[0].style.display=\"inline\"' onmouseout='this.childNodes[0].style.display=\"none\"' "
			if(v.check<2){
				a+=v.alertHTML
				u+=" onclick='this.previousSibling.style.display=\"inline\";return false' "
				}
			w = v.hintHTML+w
			delete s.href
			}*/
		else
			tg.push('</div>')
		if(u.shiftX || u.shiftY){
			if(!arg.shiftElm)
				arg.shiftElm=[]
			arg.shiftElm.push(u)
			}
		for(var i in s)
			y+=i+':'+s[i]+';'
		for(var i in t)
			z+=i+'('+t[i]+') '
		if(z)
			y+="transform:"+z
		//console.log(a+"<"+u+" style='"+y+"'>"+w)
		return a+"<"+u.tagName+(u.id?" id='"+u.id+"'":'')+(u.src?" src='"+u.src+"'":'')+(u.onload ? " onload='"+u.onload+"'" : '')+(u.onmousemove ? " onmousemove='"+u.onmousemove+"'" : '')+" style='"+y+"'>"+(u.innerHTML?u.innerHTML:'')
		})
/*
	arg.txt = arg.txt.replace(/(?:<br \/>\s*)?\[\/style\](?:<br \/>\s*)?/g,function($0){
		if(l){
			l--
			return "</div>"
			}
		return '<!--[fixsize][style]not match-->'
		})*/
	
	while(tg.length)
		arg.txt +=tg.pop()+'<!--[fixsize][style]not match-->'

	arg.txt = arg.txt.replace(/\[omit\s?(\d+)\](.+?)\[\/omit\]/g,function($0,$1,$2){return "<span title='"+$2+"'>"+commonui.cutstrbylen($2,$1|0,$1-1,'…')+"</span>"})
	arg.txt = arg.txt.replace(/\[symbol (.+?)\]/g,function($0,$1){return __TXT($1,2)})
	arg.txt = arg.txt.replace(/\x00/g,'<br />')
	arg.txt +="</div></div>"//+(arg.shiftElm?"<img src='about:blank' onerror='this.previousSibling.onmousemove=ubbcodeParseFixMousemove'/>":'')
	//arg.txt +="<img src='about:blank' onerror='ubbcode.parseFix.adjsize(\""+arg.argsId+"\",this.previousSibling.firstChild)' style='display:none'/>"
}//fe


ubbcode.parseFix.dybg = function(e,o,argsId,px,py,dx,dy){
	//console.log(dx)
if(dx || dy){
	if(dx){
		var x = (e.offsetX-(o.offsetWidth/2))/(o.offsetWidth/2)
		x = (dx>>1)/1000*x
		px+=x*1000<<1
		}
	if(dy){
		var x = (e.offsetY-(o.offsetHeight/2))/(o.offsetHeight/2)
		x = (dy>>1)/1000*x
		py+=x*1000<<1
		}
	requestAnimationFrame(function(){o.style.backgroundPosition = (px>>1)/1000+(px&1?'%':'em')+' '+(py>>1)/1000+(py&1?'%':'em')})
	//o._dybgx = px
	//o._dybgy = py
	//if(o._dybgto)
	//	clearTimeout(o._dybgto)
	//o._dybgto = setTimeout(function(){console.log(o._dybgx+' '+o._dybgy);o.style.backgroundPosition = o._dybgx+'% '+o._dybgy+'%'},100)
	}
}//fe

/*
ubbcodeParseFixMousemove = function(e){
	
}//fe
*/

//=============================

ubbcode.imgGen = function(opt,src,noimg,arg){

//处理选项
if(opt=='-1'){//-1 生成QR码
	var id = 'qr'+Math.random()
	this.manualLoadCache[id] = this.unSecureText(src).replace(/^\[url\]|\[\/url\]$/g,'')
	return "<img src='about:blank' onerror='commonui.QRCode.loadDataUrl(this,ubbcode.manualLoadCache[\""+id+"\"])'/>"
	}
else{
	if(opt=='0')//[img0]指定按钮
		noimg |= 2
	if((arg.opt&128) && src.substr(src.length-4)=='.gif')//签名中不显示gif
		noimg |= 2
	var w='',n=''
	opt = opt|0
	if(opt>0 && opt<=100)//1~100设置百分比宽度
		w+="width:"+(opt-0.1)+"%;";
	else if(arg.opt&2){}//in [fixsize]
	else{
		w+="max-width:"+( arg.maxWidth ? arg.maxWidth-10 : 650 )+"px;" 
		//w+="max-width:90%;" 
		n+='ubbcode.adjImgSize(this);'
		}
	if(arg.opt&256)
		n+='ubbcode.bbscodeConvArgsSave["'+arg.argsId+'"].onResize();'
	}

//处理src
if(!src.match(/^[\x00-\x7F]+$/))
	return false

if(src && src.substr(0,1)=='.'){
	src = src.replace(/^\.(\d+)?\//,function($0,$1){
		if($1 && arg.urlReplace && arg.urlReplace[$1-1])
			return arg.urlReplace[$1-1]+'/'
		return commonui.getAttachBase(src)+'/'
		})
	}
if(src && !src.match(/^https?:\/\//)) 
	src = 'http://'+src;
if(commonui.correctAttachUrl)
	src = commonui.correctAttachUrl(src)

//确定显示状态
var dis, alt='';//  true显示按钮 String显示缩略图 null显示原图
if (commonui.ifUrlAttach(src) ){//附件
	var a = this.attach.check(arg.i,src),thumb=a?a.thumb:0, size = a? a.size:10000000//如果not附件则视为大图无缩略图
	if(src.match(/\.(?:thumb\.|thumb_s\.|thumb_ss\.|medium\.)[a-zA-Z0-9]+$/)){//用户指定使用缩略图
		dis = src
		src = src.replace(/\.(?:thumb\.|thumb_s\.|thumb_ss\.|medium\.)[a-zA-Z0-9]+$/,"")
		}
	else{//原图
		dis = null
		if(size>100){//biger than 100k
			if(++this.imgGen.c>50){//附件原图计数
				if(thumb&96)
					dis = src+"."+(	(thumb&64) ? 'medium' : 'thumb'  )+".jpg"
				else
					dis = true
				}
			}
		}

	if(noimg & 2)//调用时强制按钮
		dis = true
	else if((arg.opt&2)==0){//不在fixblk中
		if((noimg & 1) && (noimg & 524288))//自动最小缩略图
			dis = (thumb&32) ? src+".thumb.jpg" : (size>5 ? true : null)
		else if(noimg & 1)//自动按钮
			dis = size>5 ? true : null//biger than 5k
		}
	if((arg.opt&16) && a && !a.isThumb && arg.inTopImg){//在置顶中
		if((arg.inTopImg[0]+=a.size) && arg.inTopImg[0]>1200){
			src='about:blank'
			alt='合计不超\n过1200k'
			w=this.imgGen.s
			}
		if(arg.opt&32 && (arg.inTopImg[1]+=a.w*a.h) && arg.inTopImg[1]>200000){//长置顶
			src='about:blank'
			alt='合计不超过\n200000像素'
			w=this.imgGen.s
			}
		}
	}
else{//不是附件
	if(arg.opt&16){//在置顶中
		src='about:blank'
		alt='置顶必须\n使用附件'
		w=this.imgGen.s
		}
		
	src=src.replace(/^http:\/\/db1?\.178\.com\//i,'http://img.db.178.com/') //修正一些url
	if(arg.opt & 128){
		if(!this.checkSigImg(src)){
			src='about:blank'
			alt='image url\nnot allow'
			w=this.imgGen.s
			}
		}
	
	if(noimg & 3)//按钮
		dis=true
	else//原图
		dis=null
	}

var img = "<img "+(w?" style='"+w+"'":'')+(n?" onload='"+n+"'":'')+" src='"+src+"' alt='"+alt+"' onerror='ubbcode.imgError(this)'/>"

if(dis){
	var ck = this.randDigi('manualLoadImg', 10000)
	this.manualLoadCache[ck]=img//.replace(/max-width:\d+px/,'max-width:90%')
	if(dis === true)
		return "<button type='button' onclick='this.nextSibling.innerHTML=ubbcode.manualLoadCache[\""+ck+"\"];this.nextSibling.style.display=\"\";this.style.display=\"none\"'>显示图片</button><span style='display:none'></span>"
	else if(dis)
		return "<a href='javascript:void(0)' class='thumblink' onclick='this.nextSibling.innerHTML=ubbcode.manualLoadCache[\""+ck+"\"];this.nextSibling.style.display=\"\";this.style.display=\"none\"'><img src='"+dis+"' onerror=''/></a><span style='display:none'></span>"
	}
else
	return img
}//fe
ubbcode.imgGen.c = 0
ubbcode.imgGen.s ='border:1px solid gray;color:gray;white-space:pre;font-size:9px;line-height:20px'
ubbcode.imgError = function(o){
if(o.src!='about:blank'){
var x= o.src.replace(/^https?:\/\//,''),y=commonui.cutstrbylen(x,6).length , x=commonui.cutstrbylen(x,13,11,'...'), x = x.substr(0,y)+'\n'+x.substr(y)
o.alt=x
o.style=this.imgGen.s
o.title=o.src}
}//fe
//=============================

ubbcode.contentPrefix = function(arg){
if(arg.prefix){
	if(arg.prefix.constructor==String)
		arg.txt = arg.prefix+arg.txt
	else{
		var x,y=''
		while(x = arg.prefix.pop()){
			y+=x[0]
			arg.txt+=x[1]
			}
		arg.txt = y+arg.txt
		}
	}
if(arg.suffix)
	arg.txt+=arg.suffix
}

//=============================

ubbcode.copyChk = function(o,argsId){
if(!window.getSelection && !document.selection)
	return
var a = ubbcode.bbscodeConvArgsSave[argsId]
_$(o)._.on('copy',function(){
	var t=''
	if(a.tId)
		t+="&tid="+a.tId
	if(a.pId)
		t+="&pid="+a.pId+"&to=1"
	if(t){
		var y=commonui.range.get(),x = y.getHtml(),z = x.match(/<br\s*\/?>/g)
		if(!z || z.length<4)
			return;
		x = _$('/span').$0('style','position:fixed;right:-9999px','innerHTML',y.getHtml()+'<br/><br/>'+location.protocol+'//'+location.host+'/read.php?'+t)
		document.body.appendChild(x)
		y.selectAllChildren(x)
		window.setTimeout(function(){document.body.removeChild(x);y.select()},100)
		}
	})

}//fe
//=============================
//pa
//=============================
ubbcode.parser = function(arg){
if(!arg.txt)arg.txt = arg.c.innerHTML
var a=[],p=a,i=0,j=0,l=0,m,q,
y = function(c,d){
	var t=''
	for(var k=0;k<c;k++)
		t+='...'
	console.log(t+d[d.length-1])
	},
g = /\[(\/)?(code|collapse|urlreplace|quote|crypt|table|tr|td|del|u|b|i|sup|sub|span|dice|list|color|upup|size|font|align|album|img|flash|iframe|attach|url|tid|stid|pid|uid|h|l|r|randomblock)([^a-z\]][^\]]{0,100})?\]/gi
while(m=g.exec(arg.txt)){
	if(m[1]=='/'){
		q=p
		while(q && m[2]!=q.tag){
			q=q.p
			}
		if(q)
			p=q
		else
			continue
		p.push(arg.txt.substring(i,m.index))
		//y(j,p)
		//p.push(arg.txt.substring(m.index, g.lastIndex))
		j--
		//y(j,p)
		p=p.p
		}
	else{
		
		p.push(arg.txt.substring(i,m.index))
		//y(j,p)
		var x = []
		//x.push(arg.txt.substring(m.index, g.lastIndex))
		x.tag=m[2]
		x.opt=m[3]
		x.p = p
		p.push(x)
		p=x
		//y(j,p)
		j++
		}
	i=g.lastIndex
	if(l++>10000)break;
	}
p.push(arg.txt.substring(i))
console.log(a)
/*
'文字文字[b=123]天下太平[/b]甲乙丙丁'
会生成如下数组
[
	'文字文字',	
	[
		'天下太平',
		tag: 'b',
		opt: '=123',
		p: 到父节点的link
		],
	'甲乙丙丁',	
	]
 */
}//fe

//=============================
//upup
//=============================
ubbcode.upupProc = function(o){
if(!this.upupProc.data)
	this.upupProc.data=[]
if(o)
	this.upupProc.data.push(o)
if(!this.upup){
	if(!this.upupProc.loading){
		this.upupProc.loading = true
		loader.script(__COMMONRES_PATH+'/js_upup.js?432457', function(){ubbcode.upupProc()}, 0, 0)
		}
	return
	}
var o = this.upupProc.data.shift()
while(o){
	var x = o.innerText ? o.innerText : o.textContent
	if(x.length<8){
		o.innerHTML=''
		this.upup.txt(o,x)
		}
	o = this.upupProc.data.shift()
	}
}//fe

//=============================
//嵌套引用
//=============================
ubbcode.parseQuote = {
p:false,
a:null,
parse:function(arg){
	/*
	if(arg.txt.indexOf('[quote')==-1)
		return
	var c = 0
	arg.txt = arg.txt.replace(/(?:<br \/>)?\s*(\[\/?quote\])\s*(?:<br \/>)?|\[img[^\]]*\]|\[iframe[^\]]*\]/gi,function($0,e){
		if(e){
			if(c==0)
				return "/&#42;bbscode /quote error&#42;/"
			else
				return "[/quote"+(c--)+"]"
			}
		else{
			if()
			return "[quote"+(++c)+"]"
			}
		})
	*/
	
	this.p = arg.txt.indexOf('[quote')+1
	if(this.p)
		arg.txt = arg.txt.replace(/(?:<br \/>)?\s*(\[\/?quote\])\s*(?:<br \/>)?/gi,"$1")
	var limit=0
	this.a = arg
	while (this.p){
		if(limit++>5)break;
		arg.txt = this.exe(arg.txt,false)
		}
	return arg.txt
	},
exe:function(txt,p){
	this.p = p
	var self = this, s='' //"style='margin:0.8em;padding:0.6em 0.6em 0.6em 2.3em;border:1px solid "+__COLOR.bg0+";background-image:url(http://127.0.0.1/nga_img_zeg/ngabbs/nga_classic/quote0.png), url(http://127.0.0.1/nga_img_zeg/ngabbs/nga_classic/quote1.png);background-position:top left, bottom right;background-repeat:no-repeat,no-repeat'"
	return txt.replace(/\[quote\]([^\x00]+?)\[\/quote\]/gi,function($0,$1){//  多行匹配
			if($1.match(/\[quote\]/i))
				return '[quote]'+self.exe($1+'[/quote]',true)
			if($1.match(/^\s*\[(?:tid|pid)=[\d,]+\](?:Reply|Topic)\[\/(?:pid|tid)\] (?:\[b\])?Post by/)){
				return "<div class='quote' "+s+">\n"+
						  $1.replace(/^\s*\[(?:tid|pid)=[\d,]+\](?:Reply|Topic)\[\/(?:pid|tid)\] \[b\]Post by.+?<br \/><br \/>(\[b\]Reply to .+?\[\/uid\] \(\d+-\d+-\d+ \d+:\d+\):?(\[\/b\])?)/,function($0,$1){return $0.substr(0,$0.length-$1.length)+"<span style='padding-left:2em' class='subtxt_color'>"+$1+"</span>"})
						  .replace(/\[img(-?\d{0,3})\]/g,'[img0]').replace(/\[iframe(?:=\d+(?:,\d+)?)?\](https?:\/\/)(.+?)\[\/iframe\]/g,function($0,$1,$2){return '[url]'+$1+$2+'[/url]'})
						  +"\n</div>"//  自动截取引用可能产半个bbscode 添加换行分段
				}
			else{
				if(self.a.c){
					for(var i=0,y,z,x=self.a.c;i<3;i++){
						if(x.parentNode.className.indexOf('postrow')!=-1 && (y=commonui.getRGBFromStyle(commonui.getStyle(x,'background-color')))){
							z=commonui.getRGBFromStyle(__COLOR.quote0bg)
							y[0]=((y[0]+z[0])/2+0.5)|0
							y[1]=((y[1]+z[1])/2+0.5)|0
							y[2]=((y[2]+z[2])/2+0.5)|0
							return "<div class='quote' style='margin-left:0.8em;background-color:"+commonui.rgbToHex(y)+"' "+s+">"+$1+"</div>"
							break
							}
						else
							x=x.parentNode
						}
					}
				return "<div class='quote' "+s+">"+$1+"</div>"
				}
			}
		);
	}
}//ce
//=============================
//list
//=============================
ubbcode.parseList = {
count:false,
parse:function(arg){
	this.count = arg.txt.indexOf('[list')+1
	var limit=0
	while (this.count){
		if(limit++>5)break;
		arg.txt = this.exe(arg.txt,false)
		}
	return arg.txt
	},
exe:function(txt,count){
	this.count = count
	var self = this
	return txt.replace(/(?:<br\s*\/?>)?\[list(=.)?\](.*?)\[\/list\]\s*(?:<br\s*\/?>)?/gi,function($0,$1,$2){//  多行匹配
			if($2.match(/\[list(?:=.)?\]/i))
				return '[list'+($1?$1:'')+']'+self.exe($2+'[/list]',true)
			$2 = $2.split('[*]')
			var l = ''
			for(var i=0;i<$2.length;i++){
				$2[i] = $2[i].replace(/^<br\s*\/?>|<br\s*\/?>$/ig,'')
				if($2[i])
					l += '<li>' + $2[i] + '</li>'
				}
			if($1)
				return "<ol type"+$1+">" + l +"</ol>"
			else
				return "<ul>" + l +"</ul>"
			}
		);
	}
}//ce

//=============================
//图片尺寸调整
//=============================
ubbcode.adjImgSize = function(o){
if(o.src=='about:blank')return
var x=null,nW,nH
if(o.naturalWidth){
	nW = o.naturalWidth
	nH = o.naturalHeight
	if(o.width<nW || o.hight<nH)
		x=true
	}
else{
	x = new Image()
	x.src = o.src
	nW = x.width
	nH = x.height
	if(nW>o.width || nH>o.height)
		x=true
	else
		x=null
	}
if(x){
	o.style.border='5px solid '+__COLOR.border0
	o.onclick = function(){
		var s = this.style
		if(s.maxWidth=='none'){
			s.position = s.marginRight = s.boxShadow = ''
			s.borderColor = __COLOR.border0
			s.maxWidth = this.__mw
			}
		else{
			this.__mw = s.maxWidth
			s.position = 'relative'
			s.zIndex=2
			s.borderColor='silver'
			s.marginRight = '-'+(nW-this.width)+'px'
			s.maxWidth='none'
			s.boxShadow='0px 0px 10px black'
			}
		}

	}
}//fe

//=============================
//随机数
//=============================
ubbcode.sRand={
seed:2110032,
rnd:function(argsId){
	if (argsId){
		if(!this.seeds[argsId]){
			var arg = ubbcode.bbscodeConvArgsSave[argsId]
			this.seeds[argsId] = arg.authorId+arg.tId+arg.pId+(arg.tId>10246184 || arg.pId>200188932 ? (arg.seedOffset|0) : 0)
			if(!this.seeds[argsId])
				this.seeds[argsId]=Math.floor(Math.random()*10000)
			}
		this.seeds[argsId] = (this.seeds[argsId]*9301+49297) % 233280;
		return this.seeds[argsId]/(233280.0);
		}
	this.seed = (this.seed*9301+49297) % 233280;
	return this.seed/(233280.0);
	},
rand:function(argsId){
	return this.rnd();
	},
seeds:{}

}

// RC4-based seedrandom version 2.0. Author: David Bau 4/2/2011
// .seedrandom(seed)	set seed
// .seedrandom('yowza', true)	Seeds using the given explicit seed mixed with accumulated entropy.
// .random()	gen
/*
ubbcode.sRand_v2={}
(function(j,i,g,m,k,n,o){function q(b){var e,f,a=this,c=b.length,d=0,h=a.i=a.j=a.m=0;a.S=[];a.c=[];for(c||(b=[c++]);d<g;)a.S[d]=d++;for(d=0;d<g;d++)e=a.S[d],h=h+e+b[d%c]&g-1,f=a.S[h],a.S[d]=f,a.S[h]=e;a.g=function(b){var c=a.S,d=a.i+1&g-1,e=c[d],f=a.j+e&g-1,h=c[f];c[d]=h;c[f]=e;for(var i=c[e+h&g-1];--b;)d=d+1&g-1,e=c[d],f=f+e&g-1,h=c[f],c[d]=h,c[f]=e,i=i*g+c[e+h&g-1];a.i=d;a.j=f;return i};a.g(g)}function p(b,e,f,a,c){f=[];c=typeof b;if(e&&c=="object")for(a in b)if(a.indexOf("S")<5)try{f.push(p(b[a],e-1))}catch(d){}return f.length?f:b+(c!="string"?"\0":"")}function l(b,e,f,a){b+="";for(a=f=0;a<b.length;a++){var c=e,d=a&g-1,h=(f^=e[a&g-1]*19)+b.charCodeAt(a);c[d]=h&g-1}b="";for(a in e)b+=String.fromCharCode(e[a]);return b}i.seedrandom=function(b,e){var f=[],a;b=l(p(e?[b,j]:arguments.length?b:[(new Date).getTime(),j,window],3),f);a=new q(f);l(a.S,j);i.random=function(){for(var c=a.g(m),d=o,b=0;c<k;)c=(c+b)*g,d*=g,b=a.g(1);for(;c>=n;)c/=2,d/=2,b>>>=1;return(c+b)/d};return b};o=Math.pow(g,m);k=Math.pow(2,k);n=k*2;l(Math.random(),j)})([],ubbcode.sRand_v2,256,6,52);
*/

//=============================
//collapse
//=============================

ubbcode.collapse={
parent:ubbcode,
parse:function(arg){
if(arg.txt.indexOf('[collapse')!=-1){
	this.had = 1
	arg.txt = arg.txt.replace(/\[collapse(=[^\]]{1,50})?\](.+?)\[\/collapse\]/gi,function($0,$1,$2){
		var l=$1 ? $1.substr(1)+' ...' : '点击显示隐藏的内容 ...'
		$2 = $2.replace(/^\s*(?:<br\s*\/?>)*\s*|\s*(?:<br\s*\/?>)*\s*$/g,'')
		if(!arg.collapseBlock)arg.collapseBlock=[]
		arg.collapseBlock.push($2)
		arg.collapseAttach=1
		return "<div class='collapse_btn'><button onclick='ubbcode.collapse.load(this.parentNode.nextSibling,\""+arg.argsId+"\","+(arg.collapseBlock.length-1)+",this);' type='button' name='collapseSwitchButton'>+</button> "+l+"</div><div class='collapse_content' style='display:none'></div>";
		})
	}
if(arg.txt.indexOf('[randomblock')!=-1){
	arg.txt = arg.txt.replace(/(?:<br\s*\/?>){0,2}\s*\[randomblock\](.+?)\[\/randomblock\]\s*(?:<br\s*\/?>){0,2}/gi,function($0,$1){
		$1 = $1.replace(/^\s*(?:<br\s*\/?>)*\s*|\s*(?:<br\s*\/?>)*\s*$/g,'')
		if(!arg.randomBlock)arg.randomBlock=[]
		if(arg.txt.indexOf('[fixsize')!=-1)
			arg.opt|=2
		arg.randomBlock.push($1)
		arg.collapseAttach=1
		return arg.randomBlock.length>1 ? '' : "<div class='collapse_content' style='"+(arg.opt&2 ? 'clear:both;':'')+"height:0px;overflow:hidden'></div><img src='about:blank' class='x' onerror='ubbcode.collapse.loadr(this.previousSibling,\""+arg.argsId+"\")'/>";
		})
	}
},//fe

load:function(o,argsId,id,b){
var arg = __NUKE.inheritClone(this.parent.bbscodeConvArgsSave[argsId])
arg.txt = arg.collapseBlock[id]
arg.c = o
o.id = 'collapseBlock'+(Math.random()*10000|0)
arg.seedOffset = id+1
arg.noCov = 1
arg.isBlock = 1
arg.opt|=64
arg.adjBlkSize = function(){}
if(b)
	arg.callBack = function(){
	b.onclick=function(){
		if(b.innerHTML =='\u2212'){
			o.style.display='none'
			o.style.borderTopWidth=b.parentNode.style.borderBottomWidth=''
			b.innerHTML='+'
			}
		else{
			o.style.display=''
			o.style.borderTopWidth=b.parentNode.style.borderBottomWidth='0'
			b.innerHTML='\u2212'
			}
		}
	b.onclick()
	}
this.parent.bbsCode(arg)
},//fe

loadr:function(o,argsId,id,opt){
var $ = _$
if((!o.parentNode.className.match(/ubbcode/)||(window.__SETTING.bit&4))//不是最上级block或10寸及以下
		&& (opt&1)==0  && (this.parent.bbscodeConvArgsSave[argsId].opt&2))
	return o.parentNode.insertBefore(
		$('/button').$0('innerHTML','点击显示折叠的内容','onclick',function(){
			this.style.display='none'
			ubbcode.collapse.loadr(this.previousSibling, argsId , id, 3)}),
		o.nextSibling)

var arg = __NUKE.inheritClone(this.parent.bbscodeConvArgsSave[argsId])
if((opt&2) && arg.inTopImg)
	arg.inTopImg[0]=arg.inTopImg[1]=0
if(arg.opt&2)
	arg.noimg=0
//console.log(arg)
if(id===undefined)
	id = Math.floor(Math.random()*arg.randomBlock.length)
if(!o._selector){
	var rs = $('/div').$0('style','height:1em;lineHeight:1em;margin:1px auto;textAlign:center;overflow:hidden')
	for(var i=0;i<arg.randomBlock.length;i++)
		rs._.add($('/a').$0('href','javascript:void(0)','name',i,'className','block_txt','style','paddingTop:0;paddingBottom:0;lineHeight:1em;borderRadius:0.5em;margin:0 1em;background:'+(i==id ? __COLOR.border0 : __COLOR.border2),'innerHTML','&emsp;','onclick',function(){
				if(o._selected == this.name)return
				for(var i=0,j=this.parentNode.childNodes;i<j.length;i++)
					j[i].style.background = i==this.name ? __COLOR.border0 : __COLOR.border2
				o._selected = this.name
				ubbcode.collapse.loadr(o,argsId,this.name,3)
				})
			)
	o.parentNode.insertBefore(rs,o.nextSibling)
	o._selector = rs
	o._selected = id
	}
if('transition' in document.body.style){
	o.style.transition="all 0.2s ease-out 50ms"
	$(o)._.on('transitionend',function(){
		if(this.childNodes[1]){
			this.removeChild(this.firstChild)
			}
		})
	}
arg.txt = arg.randomBlock[id]
arg.c = $('/div').$0('style','transition:all 0.2s ease-out 50ms')
arg.noCov = 1
arg.isBlock = 1
arg.opt|=64|256
//arg.maxWidth = o.offsetWidth
arg.onResizeQue.push(function(){//块渲染完成后 内部有发生长宽变化时
	var p = this.c.getBoundingClientRect() , q = this.c.parentNode.getBoundingClientRect()
	if(p.bottom-p.top != q.bottom-q.top)
		this.c.parentNode.style.height = p.bottom-p.top+'px'
	})
arg.callBack = function(){
	var arg=this,r = __NUKE.cpblName(document.body.style,'transform',1,'transformOrigin',1), z, pi , oo, ox, i, f
	if(r && (arg.opt&2)){
		ox = arg.c.childNodes
		for(i=0;i<ox.length;i++)
			if((f=ox[i]) && f.nodeType==1 && f.className.indexOf('fixblk')!=-1){
				f.style.width='1px'//1px宽度防止父元素撑大
				break
				}
		}
	o.appendChild(arg.c)
	pi = arg.c.getBoundingClientRect()
	var pih = pi.bottom-pi.top,piw=pi.right-pi.left
	if(r && (arg.opt&2)){
		for(i=0;i<ox.length;i++){
			if((f=ox[i]) && f.nodeType==1 && f.className.indexOf('fixblk')!=-1){
				oo=f.firstChild.getBoundingClientRect()
				var oow=oo.right-oo.left
				if(oow-piw>0){
					if((z = piw/oow)<0.9){
						f.style.width = piw+'px'
						f.style.height = Math.round(oo.height*z)+'px'
						f.firstChild.style[r[1]]='top left';
						f.firstChild.style[r[0]]='scale('+z+','+z+')'
						continue
						}
					}
				f.style.width='auto'
				break
				}
			}
		pi = arg.c.getBoundingClientRect()
		pih = pi.bottom-pi.top
		}
	o.style.height=Math.round(pih)+'px'
	arg.c.style.opacity=1
	if(arg.opt&256)
		arg.onResize()
	if(o.childNodes[1])
		o.childNodes[0].style.marginBottom = '-'+o.offsetHeight+'px'
	setTimeout(function(){if(o.childNodes[1])o.removeChild(o.firstChild)},500)
	}

this.parent.bbsCode(arg)
}//fe


}//ce

//=============================
//code标签
//=============================

ubbcode.codeTag={

parent:ubbcode,
highlighter:{
	lua:"/js_highlighter.lua.js",
	php:"/js_highlighter.php.js",
	c:"/js_highlighter.c.js",
	js:"/js_highlighter.js.js",
	xml:"/js_highlighter.xml.js",
	css:"/js_highlighter.css.js",
	py:"/js_highlighter.py.js"
	},

loadedHighlighter:{},

parse:function(arg){
var self = this
arg.txt = arg.txt.replace(/\[code(=[^\]]+)?\]\s*(?:<br\s*\/?>)*\s*(.+?)\s*(?:<br\s*\/?>)*\s*\[\/code\]/gi,function($0,$1,$2){
	var l=$1?$1.substr(1):''
	if(!self.highlighter[l])l='c'
	if(!arg.blockCode)arg.blockCode=[]
	arg.blockCode.push([l,$2])
	return "<div><span class='orange'>Code <span class='gray'>"+l+"</span>:</span><br><div class='textfield'></div><img src='about:blank' onerror='ubbcode.codeTag.loadCode(this.previousSibling,\""+arg.argsId+"\","+(arg.blockCode.length-1)+")' class='x'/></div>"
	})
},//fe

loadCode:function(o,argsId,id){
var self = this , arg = this.parent.bbscodeConvArgsSave[argsId], l = arg.blockCode[id][0], parser = function(){
	self.loadedHighlighter[l]=true
	o.innerHTML=Highlighter.Execute(self.parent.unSecureText(arg.blockCode[id][1], true), l)
	o.style.height='auto'
	}

if (!window.Highlighter)
	loader.script(__COMMONRES_PATH+"/js_highlighter.js",
		function(){
			loader.script(__COMMONRES_PATH+self.highlighter[l],parser)
			})
else if(!this.loadedHighlighter[l])
	loader.script(__COMMONRES_PATH+this.highlighter[l],parser)
else
	parser();

}
/*,//fe
save:function (c){

var self = this
c = c.replace(/\[code(=[^\]]+)?\](.+?)\[\/code\]/gi,function($0,$1,$2){
	var s = $2;
	var l = null;
	var h = null;
	var hh = null;
	if ($1)l = $1.substr(1);
	if (self.highlighter[l])
		h=self.highlighter[l]
	else{
		s=s.replace(/\[/g,'&#91;').replace(/\]/g,'&#93;').replace(/ /g,'&nbsp;');
		return ("<br/><br/><span class='orange'>Code:</span><br><div class='textfield'>"+s+"</div><br/><br/>");
		}
	if (typeof(window.Highlighter)=='undefined')
		{
		window.Highlighter={'Brushes':{}};
		commonui.loadScriptInOrder(Array(__COMMONRES_PATH+"/js_highlighter.js"),function(){});
		}
	var id = 'code'+Math.floor(Math.random()*1000);
	s = s.replace(/<br\s*\/?>/ig,"\r\n").replace(/ /g,'&nbsp;').replace(/\[/g,'&#91;').replace(/\]/g,'&#93;');
	s = "<span class='orange'>Code <span class='gray'>("+l+")</span>:</span><br><div class='textfield'></div><textarea id='"+id+"' style='display:none'>"+s+"</textarea><br/><br/>";
	var prase = function(){$(id).previousSibling.innerHTML=Highlighter.Execute($(id).value,l);$(id).previousSibling.style.height='auto'}
	window.setTimeout(function(){commonui.loadScriptInOrder(__COMMONRES_PATH+h,prase)},1000);
	self.cache[id]=s
	return '['+id+']';
	}
	
	);//[code]
return c

},//fe

load:function (c){
var self = this
c = c.replace(/\[(code\d+)\]/gi,function($0,$1){
	if(self.cache[$1])
		return self.cache[$1]
	else
		return $0
	})
return c
}//fe
*/
}//ce
//=============================
//
//=============================
ubbcode.postLinkTag=function(tag,arg,txt,more){
var x = arg ? arg.split(',') : txt.split(','), y, z = tag.toLowerCase(),
txt = arg ? txt : (
	z == 'stid' ? '合集'+txt :
	((z == 'pid' || x[1] ) ? '回复'+txt : '主题'+txt)
	)
if(z=='stid'){
	y = '/thread.php?stid='+x[0]
	return this.writelink(y, txt)
	}
else if(x[1]){
	if((x[0]|0)>(x[1]|0)){
		x[4] = x[0]
		x[0] = x[1]
		x[1] = x[4]
		}
	y = x[2] ? '/read.php?tid='+x[0]+'&topid='+x[1]+'&page='+x[2]+'#pid'+x[1]+'Anchor' : '/read.php?tid='+x[0]+'&pid='+x[1]+'&to=1'
	if(txt=='Reply'||txt=='Topic')
		return this.fastViewPostLink(y,x[0],x[1],txt.substr(0,1),more)
	return this.writelink(y, txt)+this.fastViewPostLink(y,x[0],x[1],null,more,1)
	}
else if(z == 'pid'){
	y= '/read.php?pid='+x[0]
	if(txt=='Reply')
		return this.fastViewPostLink(y,x[0],x[1],txt.substr(0,1),more)
	return this.writelink(y, txt)+this.fastViewPostLink(y,0,x[0],null,more,1)
	}
else{
	y= '/read.php?tid='+x[0]
	if(txt=='Topic')
		return this.fastViewPostLink(y,x[0],x[1],txt.substr(0,1),more)
	return this.writelink(y, txt)+this.fastViewPostLink(y,x[0],0,null,more,1)
	}
}//fe

ubbcode.fastViewPostLink = function(u,tid,pid,t,more,opt){
if(!t)t=pid?'R':'T'
return (opt&1 ? '' : "<a href='"+u+"' class='block_txt block_txt_c2' style='font-weight:normal;line-height:1.2em;margin-right:-0.25em' title='打开链接' target='_blank'>+</a>")+"<a href='javascript:void(0)' class='block_txt block_txt_c0' style='line-height:1.2em' onclick='commonui.cancelBubble(event);commonui.cancelEvent(event);ubbcode.fastViewPost(event,"+tid+","+pid+","+(more?1:0)+")' title='快速浏览这个帖子'>"+t+"</a>"
}//fe

;(function(){
var p,pc,$=_$,c = commonui
ubbcode.fastViewPost = function(e,tid,pid,more){
__NUKE.doRequest({
	u:'/read.php?lite=js&tid='+tid+'&pid='+(pid?pid:0)+(more?'&opt=4':''),
	f:function(o){
		if(__NUKE.doRequestIfErr(o))
			return alert('data error')
		var j=o.data.__R__ROWS,k=j,u = o.data.__U
		if(!p){
			p = c.createCommmonWindow()
			p.id = 'fastViewPostWindow';
			p._.addContent(null)
			p._.addContent(
				$('/div').$0('className','fastViewPost',
					$('/div').$0('className','forumbox',
						pc = $('/div').$0('className','postrow'

							)
						)
					)
				)
			}
		if(pc.childNodes.length>1 || !more){
			pc.innerHTML = ''
			pc.ip = null
			}
		var n = pc.childNodes.length
		for(var i = 0;i<j;i++){
			var d = o.data.__R[i],
			pcc = $('/div',
					'className',((i+n+j)&1)?'row2':'row1',
					$('/div','className','c2','style',{padding:'6px'},
						$('/div','className','posterInfoLine b','innerHTML',u[d.authorid].username),
						$('/span','className','postcontent ubbcode','innerHTML',d.content)
						)
					)
			pc.insertBefore(pcc, pc.ip)
			ubbcode.bbsCode({c:pcc.lastChild.lastChild,
				tId:d.tid,
				pId:d.pid,
				opt:8,
				authorId:d.authorid,
				noImg:1,
				isNukePost:(d.type & 2048) ? 1 : 0,
				callBack:function(){k--;if(k==0)p._.show()}
				});
			}
		pc.ip = pc.firstChild
		return true
		}
	})
}//fe
})();

//=============================
//ubi
//=============================
;(function(){
var g = /(\s*(?:<br \/>)?\s*)(?:\[(\/?)(b|color|size|align|del|font|u|i|sub|sup|span|upup|l|r)(?:[=\s]+([^\]]+))?\])(\s*(?:<br \/>)\s*)?|\n+/gi,b={},off,aa,
r = function($0,brs,e,t,opt,bre,of){
if(!brs || t=='l' || t== 'r')
	brs = ''
if(!bre || t=='l' || t== 'r')
	bre = ''
if(!opt)
	opt=''
return brs+rr($0,e,t,opt,of)+bre
},
rr= function($0,e,t,opt,of){
if($0=='\n'){//在换行处分段如有未结束的tag强行结束
	var n=''
	for(var k in b){
		while(b[k]>0){
			n+='</span>'
			b[k]--
			}
		}
	return n+'\n'
	}
t = t.toLowerCase()
if(!b[t])
	b[t]=0
if(e){
	if(b[t]>0)
		b[t]--
	else
		return '/* bbscode '+t+' not match */'
	}
else
	b[t]++
if(t=='del')
	return e? " </span>" : "<span style='text-decoration:line-through' class='gray'> "
else if(t=='u')
	return e? "</span>" : "<span style='text-decoration:underline'>"
else if(t=='b')
	return e? "</span>" : "<span style='font-weight:bold'>"
else if(t=='i' || t=='sup' || t=='sub'){
	if(e){
		if(of-off[t]>55)
			return "</span>/* bbscode "+t+" too long */"
		if(t=='i')
			return "</span><img style='display:none' src='about:blank' onerror='this.previousSibling.style.fontStyle=\"italic\"'/>"
		else if(t=='sub')
			return "</span><img style='display:none' src='about:blank' onerror='this.previousSibling.style.fontSize=\"50%\"'/>"
		else if(t=='sup')
			return "</span><img style='display:none' src='about:blank' onerror='this.previousSibling.style.fontSize=\"50%\";this.previousSibling.style.verticalAlign=\"20%\"'/>"
		}
	else{
		off[t] = of
		return "<span>"
		}
	}
else if(t=='color'){
	if(e)
		return '</span>'
	var c
	if(opt && (c = opt.match(/^(bg)?(skyblue|royalblue|blue|darkblue|orange|orangered|crimson|red|firebrick|darkred|green|limegreen|seagreen|teal|deeppink|tomato|coral|purple|indigo|burlywood|sandybrown|sienna|chocolate|silver|gray)\s*$/i))){
		if(c[1])
			return "<span class='small_colored_text_btn white' style='font-family:inherit;background-color:"+c[2]+"'>"
		else
			return "<span class='"+c[2]+"'>"
		}
	else
		return "<span>/* bbscode color error */"
	}
else if(t=='font'){
	if(e)
		return '</span>'
	var c = opt.match(/^(simsun|simhei|Arial|Arial Black|Book Antiqua|Century Gothic|Comic Sans MS|Courier New|Georgia|Impact|Tahoma|Times New Roman|Trebuchet MS|Script MT Bold|Stencil|Verdana|Lucida Console)\s*$/i)
	if(c)
		return "<span style='font-family:"+c[1]+"'>"
	else
		return "<span>/* bbscode font error */"
	}
else if(t=='size'){
	if(e)
		return '</span>'
	var c = opt.match(/^(\d{1,3})%?\s*$/i)
	if(c)
		return "<span style='font-size:"+(c[1]|0)+"%;line-height:183%'>"
	else
		return "<span>/* bbscode size error */"
	}
else if(t=='l'||t=='r'){
	if(e)
		return '</span>'
	/*if(opt){
		var c = opt.replace(/^\s+/,'').split(/\s+/),i=0,j
		while(i<2){
			if(j= parseInt(c[i],10)){
				if(c[i].substr(c[i].length-2)=='em')
					c[i] = j+'em'
				else
					c[i] = (j-0.05)+'%'
				}
			else
				c[i] = 0
			i++
			}
		if(c[0]){
			if(c[1])
				opt=";overflow:hidden;min-width:"+c[0]+";max-width:"+c[1]+"'"
			else
				opt=";overflow:hidden;width:"+c[0]
			}
		else
			opt=''
		}
	else
		opt=''
	*/
	return "<span style='display:block;' class='"+(t=='l'?'left':'right')+"'>"
	}
else if(t=='align'){
	if(e)
		return '</span>'
	var c = opt.match(/^(left|right|center)\s*$/i)
	if(c)
		return "<span class='"+(c[1]=='center'?'tac':(c[1]=='right'?'tar':''))+"' style='display:block;text-align:"+c[1]+"'>"
	else
		return "<span>/* bbscode align error */"
	}
else if(t=='upup'){
	if(e)
		return '</span>'
	return "<img src='about:blank' style='display:none' onerror='ubbcode.upupProc(this.nextSibling)'/><span style='font-weight:bold'>"
	}
else if(t=='span'){
	if(e)
		return '</span>'
	else{
		if(opt=='aligntable')
			return "<img style='display:none' src='about:blank' onerror='ubbcode.ubi.aligntable(this.nextSibling,\""+(aa? aa.argsId:'')+"\")'/><span style='display:none'>"
		else
			return "<span>/* bbscode "+t+" need option */"
		}
	}


}//fe
ubbcode.ubi={
parse:function(arg){
var n = ''
off={}
b={}
aa=arg
if(arg.constructor===Object)
	n = arg.txt.replace(g,r)
else
	n = arg.replace(g,r)
for(var k in b){
	while(b[k]>0){
		n +='/* bbscode '+k+' not match */'
		n +='</span>'
		b[k]--
		}
	}
if(arg.constructor===Object)
	arg.txt = n 
else
	return n
},
aligntable:function(o,argsId){
var $=_$,j=0,tc=[],arg = ubbcode.bbscodeConvArgsSave[argsId],iff = function(t){
	if(t.nodeName=='DIV' && t.firstChild && t.firstChild.nodeName=='TABLE' && t.firstChild==t.lastChild)
		return 1
	}
for(var i=0;i<o.childNodes.length;i++){
	var t =o.childNodes[i]
	if(iff(t)){
		tc.push(t)
		j++
		}
	else if(t.nodeName=='BR')
		t.style.display='none'
	}
if(j>8)j=8
for(var i=0;i<tc.length;i++){
	$(tc[i],'style','cssFloat:left;width:'+(100/j)+'%;maxWidth:'+(100/j)+'%;minWidth:24em;overflow:hidden;marginRight:-1px;marginBottom:-1px;borderTop:1px solid '+__COLOR.border3+';borderRight:1px solid '+__COLOR.border3)
	$(tc[i].firstChild,'style','width:100.1%;borderTop:none;borderRight:none')
	}
o.appendChild($('/div','className','clear'))
o.style.paddingBottom='1px'
o.style.paddingRight='1px'
o.style.display='block'
arg.opt |=256
arg.onResizeQue.push(function(){
	j=0
	for(var i=0;i<tc.length;i++){
		if(tc[i].firstChild.offsetHeight>j)
			j=tc[i].firstChild.offsetHeight
		}
	for(var i=0;i<tc.length;i++){
		tc[i].firstChild.style.height = j+'px'
		}
	})
if(arg.opt&256)
	arg.onResize()
}//
/*c:function(o){
var y = o.parentNode, x=y.previousSibling
if(x && (x.nodeName=='SUB' || x.nodeName=='SUP')){
	window.setTimeout(function(){
		if(x.offsetWidth>y.offsetWidth)
			x.style.marginRight = '-'+y.offsetWidth+'px'
		else
			x.style.marginRight = '-'+x.offsetWidth+'px'
		},1000)
	}
}//fe
*/
}//ce
})();


//===========
//图文头条
ubbcode.parseHeadline = function(arg){
var x=[],self = this
arg.txt = arg.txt.replace(/(?:<br\s*\/?>)*\s*\[headline\](.+?)\[\/headline\]\s*(?:<br\s*\/?>)*/ig,function ($0,$1){x.push($1);if(x.length==1)return '[headlinehere]';else return ''});
arg.txt = arg.txt.replace('[headlinehere]',function (){
if(x){
	var td1,td2
	var z =[]
	for (var k=0;k<x.length;k++)
		{
		var u = x[k].match(/\[url(=[^\[\]]+?)?\](.+?)\[\/url\]/i)
		if(u)
			u=u[1] ? self.writelink(u[1].substr(1),u[2]) : self.writelink(u[2])
		else
			{
			u = x[k].match(/\[(tid|pid)=?([\d,]{0,50})\](.+?)\[\/\1\]/i)
			if(u)
				u= self.postLinkTag(u[1],u[2],u[3])
			else
				{
				u = x[k].match(/\[hltxt\](.+?)\[\/hltxt\]/i)
				if(u)
					u=u[1]
				}
			}
			
		if(u)u='<span class=hltxt>'+u+'</span>'
		var i = x[k].match(/\[img\](.+?)\[\/img\]/i)
		if(i){
			if (arg.noImg)
				u = self.writelink(i[1]), i=null
			else
				i=i[1], z._Img=1
			}
		z.push({'i':i,'u':u})
		}
	if(!self.loadHeadLineElm)self.loadHeadLineElm = []
	self.loadHeadLineElm.push(z)

	return '<div></div><img style="display:none" src="about:blank" onerror="ubbcode.loadHeadLine(this.previousSibling,'+(self.loadHeadLineElm.length-1)+')"/>'
	}
});
}//fe



ubbcode.mediaBlk = function(arg,uu){
var x=uu.pathname.match(/\.(.{1,5})$/)
if(x){
	if((x[1]=='mp4'||x[1]=='ogg'||x[1]=='webm') && (arg.opt&1)){
		return "<a class='video' href='"+uu.url+"' target='_blank' style='text-align:center;display:table-cell' onclick='commonui.cancelEvent(event);if(this.__clicked)return;this.__clicked=1;this.childNodes[0].style.display=\"none\";this.childNodes[1].src=this.href;this.childNodes[1].play()'><i class='silver'>点击开始<br/></i><video controls preload='none'><source src='' type='video/"+x[1]+"'></video></a>"
		}
	else if(x[1]=='aac'||x[1]=='mp3'){
		return "<div class='video' style='text-align:center;display:table-cell'><audio controls preload='none'><source src='"+uu.url+"' type='audio/"+x[1]+"'></audio></div>"
		}
	}
return null
}//fe

//============================
//flash

ubbcode.parseFlash = function(arg){
var self = this
arg.txt = arg.txt.replace(/\[flash(?:=(video|audio))?\](.+?)\[\/flash\]/gi,function($0,$1,$2){
	var w=0, h=0,x,i,uu,para,u=
			  $2.replace(/\.bilibili\.(?:us|tv)/,'.bilibili.com')
			  .replace(/(is)?Auto(Play)?=.+?(&|$)/ig,'')
			  .replace('static.acfun.tv','cdn.aixifan.com')
	if(u.substr(0,2)=='./')
		u = commonui.getAttachBase(u)+'/'+u.substr(2);
	if(!u.match(/^https?:\/\//))
		u = 'http://'+u
	var ua = self.urlToAry(u),u=ua.url
	if(x=u.match(/^http:\/\/v\.youku\.com\/v_show\/id_(.+?)\.html/i))
		uu = u,	u='http://player.youku.com/player.php/sid/'+x[1]+'/v.swf';
	else if(x=u.match(/^http:\/\/www\.bilibili\.com\/video\/av(\d+)/i))
		uu = u,	u='http://share.acg.tv/flash.swf?aid='+x[1]+'&page=1', w=544, h=415;
	else if(x=u.match(/^http:\/\/live\.bilibili\.com\/live\/(\d+)/i))
		uu = u,	u='http://static.hdslb.com/live/LivePlayerEx.swf?room_id='+x[1]+'&state=LIVE', w=892, h=499;
	else if(x=u.match(/^http:\/\/www\.acfun\.(?:com|tv|cn)\/v\/ac(\d+(?:_\d+)?)/i))
		uu = u,	u='http://cdn.aixifan.com/player/ACFlashPlayer.out.swf?type=page&url=http://www.acfun.com/v/ac'+x[1];
	else if(x=u.match(/^http:\/\/www\.letv\.com\/ptv\/vplay\/(\d+)\.html/i))
		uu = u,	u='http://i7.imgs.letv.com/player/swfPlayer.swf?id='+x[1]+'&autoplay=0';
	else if(x=u.match(/^http:\/\/v\.qq\.com\/(?:cover|page)\/[a-zA-Z0-9\/]+\/([a-zA-Z0-9]+)\.html(?:\?vid=([a-zA-Z0-9]+))?/i))
		uu = u,	u = 'http://v.qq.com/iframe/player.html?tiny=0&auto=0&vid='+(x[2] ? x[2] : x[1]), i=1, w=640, h=498
	else if(x=u.match(/^http:\/\/v\.pptv\.com\/show\/(.+?)\.html/i))
		uu = u,	u='http://player.pptv.com/v/'+x[1]+'.swf';
	else if(x=u.match(/^http:\/\/v\.163\.com\/paike\/([a-zA-Z0-9]+)\/([a-zA-Z0-9]+)\.html/i))
		uu = u,	u = 'http://v.163.com/swf/video/NetEaseFlvPlayerV3.swf?topicid=1000&vid='+x[2]+'&sid='+x[1];
	else if(x=u.match(/^http:\/\/www\.huomaotv\.cn\/live\/(\d+)/i))
		uu = u, u = 'http://www.huomaotv.cn/index.php?c=outplayer&live_id='+x[1], w=510, h=498, i=1
	else if(x=u.match(/^http:\/\/www\.zhanqi\.tv\/(\d+)/i))
		uu = u, u = 'http://www.zhanqi.tv/live/embed?roomId='+x[1]+'&fhost=NGA', w=700, h=394, i=1
	else if(x=u.match(/^http:\/\/www\.66play\.com\/Home\/share\/(?:video|match)(?:\/|\?)id(?:\/|=)(\d+)/i))
		uu = u, u = 'http://www.66play.com/home/VideoPlay/index?id='+x[1], w=640, h=400, i=1	
	else if(x=u.match(/^http:\/\/(?:www\.)?feixiong\.tv\/Video\/(?:play\/id\/|fx_)(\d+)/i))
		uu = 'http://www.feixiong.tv/Video/fx_'+x[1], u = 'http://www.feixiong.tv/video/share/id/'+x[1], w=510, h=498, i=1

	var x=self.mediaBlk(arg,ua)
	if(x)
		return x

	if (self.checklink(ua,1)<2)
		return $0


	if(!uu){
		if(x=u.match(/^http:\/\/static\.hdslb\.com\/live\/LivePlayerEx\.swf\?room_id=(\d+)/i))
			uu = 'http://live.bilibili.com/live/'+x[1]+'.html', w=892, h=499;
		else if(x=u.match(/^http:\/\/static\.hdslb\.com\/live\/LivePlayerEx\.swf\?room_id=(\d+)/i))
			uu = 'http://live.bilibili.com/live/'+x[1]+'.html', w=892, h=499;
		else if(x=u.match(/^http:\/\/static\.hdslb\.com\/miniloader\.swf\?aid=(\d+)/i))
			uu = 'http://www.bilibili.com/video/av'+x[1], w=544, h=415;
		else if(x=u.match(/^http:\/\/share\.acg\.tv\/flash\.swf\?aid=(\d+)/i))
			uu = 'http://www.bilibili.com/video/av'+x[1];
		else if(x=u.match(/^http:\/\/player\.youku\.com\/player\.php.*\/sid\/([a-zA-Z0-9=]+)\/v\.swf/i))
			uu = 'http://v.youku.com/v_show/id_'+x[1]+'.html';
		else if(x=u.match(/^http:\/\/player\.pptv\.com\/v\/(.+?)\.swf/i))
			uu = 'http://v.pptv.com/show/'+x[1]+'.html';
		else if(x=u.match(/^http:\/\/cdn\.aixifan\.com\/player\/ACFlashPlayer\.out\.swf\?type=page&(?:amp;)?url=http:\/\/www\.acfun\.com\/v\/ac(\d+)/i))
			uu = 'http://www.acfun.com/v/ac'+x[1];
		else if(x=u.match(/^http:\/\/i\d+\.imgs\.letv\.com\/player\/swfPlayer\.swf\?id=(\d+)/i))
			uu = 'http://www.letv.com/ptv/vplay/'+x[1]+'.html';
		else if(x=u.match(/^http:\/\/static\.video\.qq\.com\/TPout\.swf\?vid=([a-zA-Z0-9]+)/i))
			u= 'http://v.qq.com/iframe/player.html?tiny=0&auto=0&vid='+x[1], uu = 'http://v.qq.com/iframe/player.html?tiny=0&auto=0&vid='+x[1], w=640, h=498,i=1
		else if(x=u.match(/^http:\/\/v\.163\.com\/swf\/video\/NetEaseFlvPlayerV\d+\.swf\?(?:topicid=\d+&(?:amp;)?)?vid=([a-zA-Z0-9]+)&(?:amp;)?sid=([a-zA-Z0-9]+)/i))
			uu = 'http://v.163.com/paike/'+x[2]+'/'+x[1]+'.html';
		else if(x=u.match(/^http:\/\/player\.video\.qiyi\.com\/[a-zA-Z0-9]+\/[a-zA-Z0-9]+\/[a-zA-Z0-9]+\/v_([a-zA-Z0-9]+)\.swf/i))
			uu = 'http://www.iqiyi.com/v_'+x[1]+'.html';
		else if(x=u.match(/^http:\/\/s3\.pdim\.gs\/static\/[a-zA-Z0-9]+\.swf.+?roomUrl=http:\/\/www\.panda\.tv\/room\/(\d+)/i))
			uu = 'http://www.panda.tv/room/'+x[1],	w=928, h=587
		else if(x=u.match(/^https?:\/\/(?:staticlive|www)\.(douyu\.tv|douyutv\.com|douyu\.com|douyucdn\.cn)/i)){
			var y =u.match(/((?:fromuid=)?\d{2,10})/gi)
			if(y)
				u = 'http://staticlive.'+x[1]+'/common/share/play.swf?room_id='+y[0], w=640, h=360,uu='http://www.douyu.com/'+y.join('?')
			else
				return $0
			}
		else if(x=u.match(/^http:\/\/bogou\.tv/i)){
			x=u.match(/(\d{2,10})/i)
			if(x)
				u = 'http://bogou.tv/swfs/BogouPlayer.swf?cId='+x[1], w=640, h=360
			else
				return $0
			}
		else if(x=u.match(/^http:\/\/www\.66play\.com/i)){
			x=u.match(/(\d{3,10})/i)
			uu = 'http://www.66play.com/Home/share/video/id/'+x[1], w=640, h=400, i=1
			}
		else if(x=u.match(/^http:\/\/www\.huomaotv\.cn\/index\.php\?c=outplayer&(?:amp;)?live_id=(\d+)/i))
			uu = 'http://www.huomaotv.cn/live/'+x[1], w=510, h=498, i=1
		else if(x=u.match(/^http:\/\/www.feixiong.tv\/Public\/static\/swf\/FXPlayerManager\.swf\?id=(\d+)/i))
			uu = 'http://www.feixiong.tv/Video/fx_'+x[1], u = 'http://www.feixiong.tv/video/share/id/'+x[1], w=510, h=498, i=1
		}

	if(!para)
		para = "<param name='movie' value='"+u+"'>"

	if(w==0 && h==0){
		if(uu)
			w=600,	h=498;
		else
			w=480,	h=400;
		}

	self.videonum++
	var id = self.randDigi('manualLoadSwf', 10000)
	self.manualLoadCache[id]= i ? 
	"<iframe height="+h+" width="+w+" src='"+u+"' frameborder=0 allowfullscreen></iframe>"
	: "<object width='"+w+"' height='"+h+"' classid='clsid:D27CDB6E-AE6D-11cf-96B8-444553540000' codebase='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,0,0'>"+para+"<embed src='"+u+"' quality='high' type='application/x-shockwave-flash' width='"+w+"' height='"+h+"' allowfullscreen='true' allownetworking='all' allowscriptaccess='always' base='.'></embed></object>"
	//var x = "<div class='video' style='width:"+w+"px'><div class='spacer' style='width:"+w+"px;height:"+h+"px;'><a href='javascript:void(0)' class='play' onclick='this.parentNode.style.background=\"none\";this.parentNode.innerHTML=ubbcode.manualLoadCache[\""+id+"\"]'></a></div><div class='moreinfo'>"+(uu? "<a href='"+uu+"' class='xtxt silver' target='_blank'>"+uu+"</a><br/>":'')
	var x = "<div class='video' style='width:"+w+"px'><div class='spacer' style='width:"+w+"px;height:"+h+"px;'><a href='"+(uu?uu:u)+"' class='play' target='_blank'></a></div><div class='moreinfo'>"+(uu? "<a href='"+uu+"' class='xtxt silver' target='_blank'>"+uu+"</a><br/>":'')
	+"<i class='silver'>如在以上内容中出现任何广告性信息并不代表本站支持其立场</i></div></div>"
	if(arg.noImg || self.videonum>1){
		var id = self.randDigi('manualLoadSwf', 10000)
		self.manualLoadCache[id]=x
		return "<button type='button' onclick='this.nextSibling.innerHTML=ubbcode.manualLoadCache[\""+id+"\"];this.nextSibling.style.display=\"\";this.style.display=\"none\"'>点击显示视频</button><span style='display:none'></span>"
		}
	else
		return x
	} );//[flash]
}//fe

//=============================
//t.178.com
//=============================

ubbcode.parseT178 = function(arg){
var self = this,$ = _$
arg.txt = arg.txt.replace(/\[t\.178\.com\/(.+?)\]/,function($0,$1){
	if($1.substr(0,1)=='#'){
		//var arg = self.bbscodeConvArgsSave[argsId]
		if (arg.opt&128)return;
		var x = arg.c,b=null
		while (x!=document.body){
			x=x.parentNode
			if(x.className.match(/c\d+/)){
				b=commonui.rgbToHex(commonui.getStyle(x,'backgroundColor')).substr(1)
				break}
			}
		var x = $('<a/>')._.css('display','none')
		arg.c.appendChild(x)
		var a = commonui.rgbToHex(commonui.getStyle(x,'color')).substr(1),c = commonui.rgbToHex(commonui.getStyle(arg.c,'color')).substr(1),u ="http://t.178.com/widget/topic/publish?keyword="+encodeURIComponent($1.substr(1,$1.length-2))+"&height=400&color="+b+','+c+','+a+"&number=20"
		arg.c.removeChild(x)
		return "<div style='border:1px solid #444;border-left:none;border-right:none;width:90%;height:645px;overflow:hidden'><iframe frameborder=0 marginheight=0 marginwidth=0 scrolling='no' style='border:none;width:100%;height:635px;overflow:hidden;margin:0;background:transparent' src='"+u+"'></iframe><div style='font-size:8px;line-height:10px;height:10px;overflow:hidden'>IFRAME:"+u+"</div></div>";
		} 
	var id = self.randDigi('t178', 10000)
	httpDataGetter.script_muti_get('http://t.178.com/api/nga/get_tweets?js=1&user_id='+$1,
		function(r){
			if(!r)r={result:false,code:0,reason:0}
			if(r.result==false)
				$(id).innerHTML = '<span class=silver>[t.178.com:ERROR:' + r.code + ' ' + r.reason+']</span>'
			else{
				if(r.data)
					$(id).innerHTML =  self.bbscode_t178_tpl(r.data[0],null,$1)
				else
					$(id).innerHTML =  "<span class=silver>[t.178.com/"+$1+":ERROR:无内容]</span>"
					
				}
			return true
			},
		function(){
			$(id).innerHTML = '<span class=silver>[t.178.com:ERROR:无法获取数据]</span>'
			}
		);
	return "<span id='"+id+"'></span>"
	});
}

ubbcode.bbscode_t178_tpl=function(d,s,uid){
if (uid && !d.user.user_id)
	d.user.user_id=uid
var a = parseInt(d.user.user_id,10).toString(16);
if(a.length<8)
	a = (new Array(8-a.length+1).join('0'))+a
a = d.user.user_id ? "http://pic1.178.com/avatars/"+a.substr(0,2)+"/"+a.substr(2,2)+"/"+a.substr(4,2)+"/50_"+d.user.user_id+".jpg" : window.__IMG_STYLE+"/nobody.gif"
var sn = commonui.cutstrbylen(d.user.nickname,4)
if(sn!=d.user.nickname)sn+='...'

return "<table class='defaultcolor'"+(s?" style='"+s+"'":'')+"><tr><td class='comment1' style='line-height:1.2em;padding-left:2px'>"+
"<nobr><a href='"+d.user.url+"' class='author' target='_blank'><b>"+sn+"</b></a>"+
(parseInt(d.user.vip_type,10) ? "<sup class='silver vip"+d.user.vip_type+"' style='line-height:0.5em'>v</sup>" :'')+
"</nobr><br/><span></span><img src='about:blank' class='x' onerror='this.previousSibling.innerHTML=commonui.loadPostPortrait(\""+a+"\")'/></td><td style='padding:1px;vertical-align:middle'>"+
"<table><tr><td class='b9tl'></td><td class='b9t'></td><td class='b9tr'></td></tr><tr><td class='b9lcc'></td><td class='b9c comment2' style='padding:3px'>"+
"<span class='content' style='line-height:1.5em'>"+
(sn!=d.user.nickname ? "<nobr><a href='"+d.user.url+"' class='author' target='_blank'><b>"+d.user.nickname+"</b></a>"+(parseInt(d.user.vip_type,10) ? "<sup class='silver vip"+d.user.vip_type+"' style='line-height:0.5em'>v</sup>" :'')+"</nobr> : " : '')+
d.content+
(d.resource ? "<br/><span class='resource' style='padding-left:30px;'><a href='"+d.resource.url+"' class='gray b' target='_blank'>"+d.resource.title+"</a></span>" : '')+
(d.source_tweet ? (d.source_tweet.source_tweet ? "<br/><span class='resource' style='padding-left:30px;'><a href='http://t.178.com/t/"+d.source_tweet.id+"' class='gray b' target='_blank'>t.178.com/t/"+d.source_tweet.id+"</a></span>" : this.bbscode_t178_tpl(d.source_tweet)) : '')+
"</span>"+
(d.pic ? "<br/><span class='pic' style='padding-left:30px;'><a href='"+d.pic.large+"' target='_blank'>"+(d.pic.thumb?"<img src='"+d.pic.thumb+"' style='border:1px solid #000'/>":'[图片]')+"</a></span>" :'')+
(d.video ? "<br/><span class='video_t' style='padding-left:30px;'><a href='"+d.video.shorturl+"' title='"+d.video.title+"' target='_blank' class='b'>"+(d.video.thumb?"<img src='"+d.video.thumb+"' style='border:1px solid #000'/>":'[观看视频]')+"</a></span>" :'')+
"<nobr style='font-size:9px;line-height:12px;margin:0 0 -0.5em 0;text-align:right;display:block;-webkit-text-size-adjust: none;'>"+
"<span class='date silver'>"+commonui.time2shortdate(d.create_time)+"</span> "+
 "<span class='view'><a href='"+( d.id ? 'http://t.178.com/t/'+d.id : d.user.url )+"' class='gray b' target='_blank'>"+( d.id ? 't.178.com/t/'+d.id : d.user.url.replace('http://','') )+"</a></span> " +
//((d.source_name && d.source_url.indexOf('http://t.178.com')==-1) ? "<span class='source'><a href='"+d.source_url+"' class='gray' target='_blank'>"+d.source_url.replace(/^http:\/\//i,'').replace(/\/.*$/i,'')+"</a></span> " : '')+
"</nobr></td><td class='b9r'></td></tr><tr><td class='b9bl'></td><td class='b9b'></td><td class='b9br'></td></tr></table>"+
"</td></tr></table>"
}//fe

//=============================
//相册
//=============================
ubbcode.album = {
imgLoad:function(o,src){
var img = new Image
img.onreadystatechange = img.onload= function(){
	if(this && this.readyState && this.readyState!='complete')
		return
	this.onreadystatechange = this.onload=null
	if (this.width>this.height){
		if (this.width>400){
			o.style.height = (this.height/this.width*400)+'px'
			o.style.width='400px'
			}
		}
	else{
		if (this.height>400){
			o.style.width = (this.width/this.height*400)+'px'
			o.style.height='400px'
			}
		}
	o.src=this.src
	o.style.display=''
	o.parentNode.style.height=o.parentNode.style.width='auto'
	}
img.src=src
},//fe
open:function (id){
commonui.userCache.set('ubbcode_album_cache',this.cache[id],86400)
},//fe
cache:{},
albumCount:0
}

//=============================
//头条
//=============================


ubbcode.loadHeadLine = function (o,id){
if(!this.loadHeadLineElm || !this.loadHeadLineElm[id])return
var i,j,k,w,ww,td1,td2,tr,sel,col,cls,lt,ltr,clsr,height,tmp,x
height = 250;
if(o.offsetWidth)
	w=o.offsetWidth
else{
	w=o.parentNode
	while(!w.offsetWidth && w!=document.body)w=w.parentNode
	if(w.offsetWidth)
		w=w.offsetWidth
	else
		w=930
	}
if(this.loadHeadLineElm[id]._Img){
	if (w>=1200){
		ww = '750px'
		w='33.3%'
		col=3
		}
	else if (w>=880){
		ww = '500px'
		w='50%'
		col=2
		}
	else{
		ww = '250px'
		w='100%'
		col=1
		}
	}
else{
	if (w>=1200){
		ww = '100%'
		w='20%'
		col=5
		}
	else if (w>=930){
		ww = '100%'
		w='25%'
		col=4
		}
	else{
		ww = '100%'
		w='33.3%'
		col=3
		}
	}
td1 = _$('<td/>')._.css('width',ww)
td2 = _$('/td').$0('style',{height:height+'px'})
sel = _$('<tr/>')
lt = _$('<tbody/>')
clsr='row1'
ltr = _$('<tr/>')._.cls(clsr)
i=j=k=0
for (var k=0;k<this.loadHeadLineElm[id].length;k++)
	{
	x = this.loadHeadLineElm[id][k]
	var swapImg = function (){
			var i,t,u,x
			i= this._.gV('i');t= this._.gV('t');u= this._.gV('u');
			x = this.parentNode._x
			x._.css('backgroundImage','url('+i+')')
			x = this.parentNode._xx
			x.innerHTML = u
			//x=x.childNodes[0]
			//x.style.height=(height-40)+'px'
			//x.style.padding='15px'
			x = this.parentNode.getElementsByTagName('td')
			for (i=0;i<x.length;i++)
				x[i].className='nosel'
			this.className='seled'
			}
	if (x.i){
		sel._.aC(_$('<td/>')._.sV({'i':x.i,'u':(x.u ? x.u.replace(/^.+?<\/span> /,'').replace(/<\/a> .+$/,'</a>') : '')})._.on('mouseover',swapImg))
		i++
		}
	else{
		if(cls=='b1')cls='b2'
		else cls='b1'
		if (j==col)
			{
			if (clsr=='row1')clsr='row2'
			else clsr='row1'
			cls='b1'
			j=0
			lt._.aC(ltr)
			ltr = _$('<tr/>')._.cls(clsr)
			}
		tmp =  _$('<td/>')._.css('width',w)._.cls('headlineelm '+cls)
		tmp.innerHTML = x.u
		ltr._.aC( tmp )
		j++
		}
	}
tr = _$('/tr')._.add(
		td1._.add(
			_$('<div/>').$0(
				'className','leftblock',
				'style',{height:height+'px'},
				_$('/table')._.add(
					lt._.add(
						ltr
						)
					)
				)
			)
		)
if(i){
	var xx = _$('/div')._.cls('headlinemask')
	var x  = _$('/div').$0(
		'className','headlineimg',
		xx
		)
	td2._.add(
			_$('/div').$0(
				'className','headlinebg',
				'style',{'width':'100%','height':((height-13)+'px')},
				x
				)
			)
	sel._x = x
	sel._xx = xx
	i=100/i+'%'
	for (var k=0;k<sel.childNodes.length;k++)
		sel.childNodes[k].style.width=i
	td2._.add(
		_$('/table').$0(
			'style',{height:'13px'},
			'className','headlinesel',
			_$('/tbody').$0(
				sel
				)
			)
		)
	swapImg.call(sel.childNodes[Math.floor(sel.childNodes.length*Math.random())])
	tr._.aC(td2)
	}
o.appendChild(_$('<table/>')._.cls('headline')._.aC(_$('<tbody/>')._.aC(tr)))
}//fe





//=============================
//链接生成
//=============================
ubbcode.writelink=function(u,n)
{

var v = this.urlToAry(u)

var h = " onmouseover='ubbcode.showUrlTip(event,this)' onmouseout='ubbcode.showUrlTip(event,this)'>"+v.hintHTML;

if (v.check<2)
	h = " onclick='this.previousSibling.style.display=\"inline\";commonui.cancelEvent(event);commonui.cancelBubble(event);return false' "+h;
if(v.check==-2 && n)
	n = '被禁止的链接'
	
if(v.check==-1 && v.pathname.substr(v.pathname-10)=='/read.php'){
	var an = v.hash.match(/#pid\d+Anchor$/)
	if(an){
		an = an[0].substr(1)
		h = " onclick='if($(\""+an+"\")){window.location.hash = \"#"+an+"\";commonui.cancelEvent(event);commonui.cancelBubble(event);return false}' "+h
		}
	}
return "<span class='apd' style='vertical-align:0.05em;padding:0 0.15em;color:"+v.color+"'>[</span>"+v.alertHTML+"<a href='"+v.url+"' target='_blank' "+h+(n?n:v.url)+"</a><span class='apd' style='vertical-align:0.05em;padding:0 0.15em;color:"+v.color+"'>]</span>";
}
//fe

//[url,protocol,host,pathname,search,has,color,check,hintHTML,alertHTML]
ubbcode.urlToAry=function(u){
	if(u.match(/^[^\x00-\x1f><"']|[^\x00-\x1f><"']$/))
		u = u.replace(/^(:?\s|<br \/>)+|(:?\s|<br \/>)+$/,'')
var v = commonui.urlToAry(u)
if(!v)
	return {host:location.host,pathname:'/错误的链接',search:'',hash:'',url:location.host+'/错误的链接',pathname:'',color:'#888',check:-1,hintHTML:'',alertHTML:''}
var c='#D0D0D0', s = this.checklink(v), u
if(s==4)
	v.host = location.host
if(s==3){
	if(location.protocol=='https:' && v.protocol=='http')
		v.protocol = 'https'
	u = v.pathname+v.search+v.hash
	if(u.charAt(0)=='/')
		u = v.protocol+'://'+location.host+u
	}
else{
	u = v.protocol+'://'+v.host+v.pathname+v.search+v.hash
	if(s==0 || s==2)
		c = '#C0C0C0'
	else if(s==1)
		c = '#E9B48F'
	else if(s==-1)
		c = '#FF8080'
	else if(s==-2){
		c = '#888';
		u = '被禁止的链接'
		}
	}
v.hintHTML = "<span class='urltip' style='margin-top:auto;color:"+c+"'>"+u+" </span>"
v.alertHTML = s<2 ? "<span class='urltip' style='font-size:0.846em;padding:0.153em;text-align:center' unselectable=on><div>"+(v.protocol+'://'+'<b class="red">'+v.host+'</b>'+v.pathname+v.search+v.hash)+"</div><div class='nobr'> 此网页不属于本网站，不保证其安全性 </div><div class='nobr'> <a href='"+u+"' class='b' onclick='this.parentNode.parentNode.style.display=\"none\"' target='_blank'>继续访问</a> &emsp; &emsp; &emsp; <a class='b' href='javascript:void(0)' onclick='this.parentNode.parentNode.style.display=\"none\"'>取消</a> </div></span>" : ''
v.color = c
v.url = u
v.check = s
return v
}//fe

ubbcode.showUrlTip=function(e,p){
var o = p.firstChild
if(o.style.display!='inline'){
	if(!o.style.marginTop || o.style.marginTop=='auto'){
		var x = p.getBoundingClientRect(),s=o.style
		s.top = 0
		s.left = 0
		s.visibility='hidden'
		s.display='inline'
		var y = o.getBoundingClientRect(), z = y.width+x.left-__NUKE.position.get().cw
		if(z>0)
			s.marginLeft='-'+z+'px'
		s.marginTop = '-'+(y.bottom-y.top)+'px'
		s.top=s.left=s.visibility=''
		}
	else
		o.style.display='inline'
	}
else if(commonui.ifMouseOut(e,p)){
	o.style.display='none'
	}
}//

ubbcode.noCheckLinkCookie=__COOKIE.getMiscCookie('ngabbsnochecklink')?true:false
//=============================
//地址检查
//u为url
//3:本站镜像域名 2:可信的 1:未知 0:未检查 -1:不可信
//=============================
ubbcode.checklink=function(u,nocookie,tbl)
{
if(!tbl)tbl=this.checkLinkTable
if((u).constructor==String){
	u = this.urlToAry(u)
	if(!u)
		return 0
	}
//if (!this.noCheckLinkCookie || nocookie)
//	{
	if (u.host==location.host)return 3;
	var z = u.host.split('.'), y=z.length-1, x = z[--y]+'.'+z[y+1];
	while(tbl[x]){
		if ((tbl[x]).constructor==Object){
			tbl = tbl[x]
			if (z[--y])
				x = z[y]+'.'+x
			}
		else if((tbl[x]).constructor==Function){
			return tbl[x](u)
			}
		else{
			//if(z[--y])
			//	return tbl._
			//else
				return tbl[x]
			}
		}
	return tbl._
//	}
//else
//	return 0;
}
//fe

//=============================
//加解密
//=============================
ubbcode.crypt = {
'key':{},
'genKey':function(k){
var s=[],i=0,j=0,x;
for (; i<256; i++)
	s[i] = i;
for (i=0; i<256; i++) {
	j = (j + s[i] + k.charCodeAt(i % k.length)) % 256;
	x = s[i];
	s[i] = s[j];
	s[j] = x;
	}
this.key[k] = s
},
/* RC4 symmetric cipher encryption/decryption
Copyright (c) 2006 by Ali Farhadi.
released under the terms of the Gnu Public License.

Email: ali[at]farhadi[dot]ir
Website: http://farhadi.ir/ */
'rc4':function (k, pt) {
	if(!this.key[k])
		this.genKey(k);
	var i=0,j=0,y=0,s=[],ct='',x;
	for (; i<256; i++)
		s[i] = this.key[k][i];
	for (i=0; y<pt.length; y++) {
		i = (i + 1) % 256;
		j = (j + s[i]) % 256;
		x = s[i];
		s[i] = s[j];
		s[j] = x;
		ct += String.fromCharCode(pt.charCodeAt(y) ^ s[(s[i] + s[j]) % 256]);
	}
	return ct;
},
'cT':{
	'0':'~','1':'!','2':'#','3':'|','4':'^','5':'(','6':')','7':'=','8':'`','9':']','a':';','b':',','c':'?','d':':','e':'{','f':'}','A':';','B':',','C':'?','D':':','E':'{','F':'}'
	},
'eT':{
	'~':'0','!':'1','#':'2','|':'3','^':'4','(':'5',')':'6','=':'7','`':'8',']':'9',';':'a',',':'b','?':'c',':':'d','{':'e','}':'f'
	},
'c':function(t){
t = escape(t)
var cT =this.cT
t = t.replace(/(?:%u([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9]))/g,function ($0,$1,$2,$3,$4){
	return cT[$1]+cT[$2]+cT[$3]+cT[$4]
	})
return t
},//fe
'e':function (t){
if (t.match(/[^\*@\-_+\.\/~!#\^()=`\];,\?:\{\}|A-Za-z0-9%]/)){
	window.alert('编码错误')
	return
	}
var eT =this.eT
t=t.replace(/([~!#\^()=`\];,\?:\{\}|])([~!#\^()=`\];,\?:\{\}|])([~!#\^()=`\];,\?:\{\}|])([~!#\^()=`\];,\?:\{\}|])/g,function ($0,$1,$2,$3,$4){
	return '%u'+eT[$1]+eT[$2]+eT[$3]+eT[$4]
	})
return unescape(t)
}//fe
}//ce

ubbcode.decryptCache = {}
ubbcode.decrypt=function (pass,txt,cC,argsId){
if (!pass)
	return window.alert('请输入密码')
var txt = this.crypt.rc4(pass,this.crypt.e(txt))
txt = txt.replace(/\n/g,'<br/>').replace(/\r/g,'').replace(/\[crypt\]/g,'')
cC.style.display='none'
cC.innerHTML = txt
if(argsId && this.bbscodeConvArgsSave[argsId]){
	//var arg = []
	//for (var k in this.bbscodeConvArgsSave[argsId])
	//	arg.push(this.bbscodeConvArgsSave[argsId][k])
	//arg[0]=cC
	this.bbscodeConvArgsSave[argsId].c=cC
	this.bbsCode(this.bbscodeConvArgsSave[argsId]);
	cC.style.display=''
	}
}//fe

//=============================
//nouse
//=============================
ubbcode.sc2reply_draw=function(r,thumbbase,oi,od,oa){
if (!oa)
	return
var h = '地图: <b>'+r.map+'</b><br/>';
if (r.time)
	{
	var ih = Math.floor(r.time/3600)
	var im = Math.floor((r.time-ih*3600)/60)
	var is = Math.floor(r.time-ih*3600-im*60)
	h+='时长: <b>'+ih+':'+im+':'+is+'</b><br/>'
	}
var c ,n;
n='';
for (var i in r.player )
	{
	if(typeof(r.player[i])!='object')continue
	if(!r.player[i]['id']){
		r.player[i]['id']=r.player[i][0]
		r.player[i]['race']=r.player[i][1]
		r.player[i]['color']=r.player[i][2]
		}
	c=''
	if (r.player[i]['color'])
		c = ' style="color:#'+r.player[i]['color']+'"'
	if (r.player[i]['id']){
		h+= '<b'+c+'>'+r.player[i]['id']+'</b> <span class=gray>('+r.player[i]['race']+')</span><br/>'
		n+= '_'+r.player[i]['id']+'_['+r.player[i]['race']+']'
		}
	}
if (r.thumb){
	oi.src=thumbbase+'/'+r.thumb
	oi.onerror=null
	}
else
	oi.style.display='none'
od.innerHTML = h+od.innerHTML
oa.href += '?filename='+r.map+n+'.sc2replay'
}//fe

ubbcode.attach_org_name=function(o,n){
if (o.nodeName!='A'){
	o=o.getElementsByTagName('a')
	if(!o[0])return
	o=o[0]
	}
o.innerHTML = decodeURIComponent(n)
o.href+='?filename='+n
}//fe

//=============================
//附件
//=============================
ubbcode.attach = {
w:window,
parent:ubbcode,
ucache:{},
check:function(id,src){
var n = src.match(/\/([a-zA-Z0-9_\-]+)\.([a-zA-Z0-9_\-]+)(?:\.(thumb|thumb_s|thumb_ss|medium)\.[a-zA-Z0-9]+)?$/),x
if(!n)
	return
if((x=this.cache['attach'+id]) && (x=x.index[n[1]])){//如果在本帖的附件里
	x.ck=true
	return x
	}
if(x = n[1].match(/^-?[a-z0-9]+Q[a-z0-9]+-[a-z0-9]+([KZXM])([a-z0-9]+)(?:T([a-z0-9]+))?(?:S([a-z0-9]+)-([a-z0-9]+))?/))//如果是其他贴的附件
	return {
		size:parseInt(x[2],36)*(x[1]=='K' ? 1 : (x[1]=='Z' ? 10 : (x[1]=='X' ? 100 : (x[1]=='M' ? 1000 : 1)))),
		thumb:x[3] ? parseInt(x[3],36) : 0,
		w : x[4] ? parseInt(x[4],36) : 0,
		h : x[5] ? parseInt(x[5],36) : 0,
		type : "img",
		url_utf8_org_name : n[1],
		url : src,
		autoUrl:src.charAt(0)=='.' ? src : src.replace(/^.+?\/(mon_\d+)\//,'./$1/'),
		isThumb : n[3]?1:0,
		ext : n[2]?n[2]:''
		}
	
},//fe
disp:function(id,opt){
var a = this.cache['attach'+id],
pid = a.pid,
tid = a.tid,
authorId = a.authorId,
postTime = a.postTime,
o = a.o,
a=a.a,
b,
s = __SETTING.bit & 16,//4寸以下
x=''
for (var k=0 ;k<a.length;k++){
	if((opt&2) && a[k].type!='zip')
		a[k].ck=1
	if(opt&1){
		if(!a[k].ck)
			continue
		}
	else{
		if(a[k].type=='img' && a[k].ck){
			b=1
			continue
			}
		}
	x+=this.gen1(tid,pid,a[k].aid,authorId,a[k].url,a[k].name,a[k].type,a[k].thumb,a[k].dscp,a[k].size,a[k].url_utf8_org_name,postTime,s)
	}
o.innerHTML+=x
if(b)
	o.innerHTML+='<button style="clear:both;margin:0.8em 0.8em 0.8em 2.3em;float:left" type=button onclick="this.style.display=\'none\';ubbcode.attach.disp(\''+id+'\',1)">显示全部附件</button>'
},//fe
load:function (o,nouse,a,pid,tid,authorId,postTime,id){
if(typeof(o)=='string')o = $(o)

if(id===undefined){
	if(id = o.id.match(/(\d+)$/))
		id = 'attach'+id[1]
	else
		id = this.parent.randDigi('attach_noid', 10000)
	}
else
	id = 'attach'+id

this.cache[id] = {a:a,pid:pid,tid:tid,authorId:authorId,postTime:postTime,o:o,index:{}}

for (var k=0 ;k<a.length;k++){
	a[k].thumb = a[k].thumb|0
	if(!a.dscp)a.dscp=''
	if(!a.name)a.name=a[k].url.match(/[^\/]+$/)[0]
	this.cache[id].index[a[k].name.replace(/\.[a-zA-Z0-9]+$/,'')] = a[k]
	}

//x='<button type=button onclick="ubbcode.attach.load(this.parentNode,\''+o.id+'\',\''+id+'\')">显示附件</button>'

},//fe

gen1:function (tid,pid,aid,authorId,url,name,type,thumb,dscp,size,url_utf8_org_name,postTime,small){

var w=this.w, c= w.commonui
if (url.indexOf('/')==-1)
	url = 'mon_'+c.time2date(postTime,'Ym/d')+'/'+url;

var orglink='',main='',del=''

if (w.__GP.admincheck ||  w.__CURRENT_UID ==authorId)
	del = "<a href='javascript:void(0)' onclick='if(confirm(\"是否要删除\"))__NUKE.doPost(__API.delAttach(\""+pid+"\",\""+tid+"\",\""+(aid?aid:name)+"\"))' class='block_txt block_txt_c0' title='删除'>&#10005</a>";

if(type == 'img'){
	var s
	if(small){
		if(thumb&16)
			s = [130,97,'thumb_s']
		else
			s = [130,97,null]
		}
	else{
		if((thumb&32) || thumb==1)
			s = [320,240,'thumb']
		else if(thumb&16)
			s = [320,240,'thumb_s']
		else
			s = [320,320,null]
		}
		
	var st = "style='display:block;text-align:center;vertical-align:middle;line-height:"+s[1]+"px;height:"+s[1]+"px;width:"+s[0]+"px;overflow:hidden;background:#000'"
	
	if (s[2])
		//orglink = "<a target='_blank' href='"+c.getAttachBase(url)+"/"+url+"' target='_blank' class='block_txt block_txt_c0'>+</a>";
		main = "<a href='"+c.getAttachBase(url)+"/"+url+"' "+st+" target='_blank' title='点击查看原图'><img src='"+c.getAttachBase(url)+"/"+url+"."+s[2]+".jpg' alt='' style='vertical-align:middle;margin-right:-0.5em'/>&nbsp;</a>";
	else
		main = "<span "+st+"><img src='"+c.getAttachBase(url)+"/"+url+"' alt='' style='vertical-align:middle;margin-right:-0.5em'/>&nbsp;</span>";
	return "<div class='left quote' style='margin:0.8em'>"+dscp+'&nbsp;'+del+"<div class='clear'></div>"+main+"<div class='clear'></div></div>";
	}
else{
	var x = ''
	try{x = decodeURIComponent(url_utf8_org_name)}
	catch(x){x=''}
	return "<div class='left quote' style='margin:0.8em'>"+dscp+'&nbsp;'+del+"&nbsp;<a href='"+c.getAttachBase(url)+"/"+url+(x ? '?filename='+x : '')+"' target='_blank' class='green'>"+(x ? x : name)+"</a> ("+size+" K)</div>";

	}


},//fe

cache:{}

}


//=============================
/*
bbscode提示
0元素为简要说明
1元素为详细说明
2元素为添加向导

添加向导的结构
{
	0:'请输入用户名',//参数1提示
	1:'请输入用户id',//参数2提示
	2:{'hint:'请输入用户组',//参数3提示
		'opts':{
			0:{0:'管理员',//参数3选项0名称
				1:'admin'//参数3选项0值
				},
			1:{0:'用户',//参数3选项1名称
				1:'user'//参数3选项1值
				},
			}//参数3选项
		}
	3:function(v){
		v[0] = '[username]'+v[0]+'[/username]' 参数数组v 参数ID对应提示的id
		v[1] = '[uid]'+v[1]+'[/uid]'
		v[2] = '[group]'+v[2]+'[/group]'
		return '[user]'+v[0]+v[1]+v[2]+'[/user]'
	}//参数数组处理函数 返回生成的bbscode 如返回false则视为参数错误中止
}
*/
ubbcode.codeHelpCommon = [
{0:'<b>[color]</b><br/><nobr>文字颜色</nobr>',1:"<b>文字颜色</b><br/><br/>	选中你希望加颜色的文字并使用下面的选择器选择颜色<br/>"},
{0:'<b>[size]</b><br/><nobr>文字大小</nobr>',1:"<b>文字大小</b><br/><br/>	选中你希望改变尺寸的文字并使用下面的选择器选择尺寸<br/>"},
{0:'<b>[font]</b><br/><nobr>文字字体</nobr>',1:"<b>文字字体</b><br/><br/>	选中你希望改变字体的文字并使用下面的选择器选择字体<br/>"},
{
	0:'<b>[b]</b><br/><nobr>粗体文字</nobr>',
	1:"<b>粗体文字</b><br/><br/>	[b]甲乙丙丁戊己庚辛[/b]<br/>",
	2:{
		0:{'hint':'请输入文字'},
		1:function(v){
			return '[b]'+v[0]+'[/b]'
		}
	}
},
{
	0:'<b>[u]</b><br/><nobr>下划线文字</nobr>',
	1:"<b>下划线文字</b><br/><br/>	[u]甲乙丙丁戊己庚辛[/u]<br/>",
	2:{
		0:{'hint':'请输入文字'},
		1:function(v){
			return '[u]'+v[0]+'[/u]'
		}
	}
},
{
	0:'<b>[i]</b><br/><nobr>斜体文字</nobr>',
	1:"<b>斜体文字</b><br/><br/>	[i]甲乙丙丁戊己庚辛[/i]<br/><br/>注意斜体文字长度不能超过50个字",
	2:{
		0:{'hint':'请输入文字'},
		1:function(v){
			return '[i]'+v[0]+'[/i]'
		}
	}
},
{
	0:'<b>[del]</b><br/><nobr>删除线</nobr>',
	1:"<b>有删除线的文字</b><br/><br/>	[del]甲乙丙丁戊己庚辛[/del]<br/>",
	2:{
		0:{'hint':'请输入文字'},
		1:function(v){
			return '[del]'+v[0]+'[/del]'
		}
	}
},
{
	0:'<b>[align]</b><br/><nobr>左/中/右对齐</nobr>',
	1:"<b>左/中/右对齐文字</b><br/><br/>	[align=left]<br/>	甲乙丙丁戊己庚辛<br/>	左对齐文字<br/>	[/align]<br/><br/>	[align=center]<br/>	甲乙丙丁戊己庚辛<br/>	中对齐文字<br/>	[/align]<br/><br/>	[align=right]<br/>	甲乙丙丁戊己庚辛<br/>	右对齐文字<br/>	[/align]<br/>	",
	2:{
		0:{'hint':'请输入文字'},
		1:{
			'hint':'选择对齐方向',
			'opts':{
				0:{0:'中对齐',1:'center'},
				1:{0:'右对齐',1:'right'},
				2:{0:'左对齐',1:'left'}
				}
			},
		2:function(v){
			return '[align='+v[1]+']'+v[0]+'[/align]'
		}
	}
},
{
	0:'<b>[h]</b><br/><nobr>段落标题</nobr>',
	1:"<b>段落标题</b><br/><br/>	[h]甲乙丙丁戊己庚辛[/h]<br/><br/>	或使用三连等号亦可<br/><br/>	===甲乙丙丁戊己庚辛===<br/>	",
	2:{
		0:{'hint':'请输入标题文字'},
		1:function(v){
			return '==='+v[0]+'==='
		}
	}
},
{0:'<b>[l/r]</b><br/><nobr>左/右浮动</nobr>',1:"<b>段落左/右浮动</b><br/><br/>	[l]左浮动段落<br/>	甲乙丙丁戊己庚辛[/l]<br/><br/>	[r]右浮动段落<br/>	甲乙丙丁戊己庚辛[/r]<br/><br/>	"},//[l 20]可以设置百分比宽度[/l]<br/><br/>	[l 20 40]可以设置最小/最大宽度[/l]<br/><br/>	[l 20em 40]可以设置绝对宽度[/l]<br/>	"},
{
	0:'<b>[list]</b><br/><nobr>列表条目</nobr>',
	1:"<b>列表条目</b><br/><br/>	[list]<br/>	[*]条目1<br/>	[*]条目2<br/>	[*]条目3<br/>	[*]条目4<br/>	[/list]<br/>	",
	2:{
		0:{'hint':'第1条'},
		1:{'hint':'第2条'},
		2:{'hint':'第3条'},
		3:{'hint':'第4条'},
		4:{'hint':'第5条'},
		5:{'hint':'第6条'},
		6:{'hint':'第7条'},
		7:{'hint':'第8条'},
		8:{'hint':'第9条'},
		9:{'hint':'第10条'},
		10:function(v){
			var x=''
			for (var i=0;i<v.length;i++)
				{
				if (v[i])
					x+='[*]'+v[i]+'\n'
				}
			return '[list]'+x+'[/list]'
		}
	}
},
{
	0:'<b>[img]</b><br/><nobr>插入图片</nobr>',
	1:"<b>插入图片</b><br/><br/>	[img]http://xxx.com/ooo.jpg[/img]<br/>	",
	2:{
		0:{'hint':'请输入图片地址'},
		1:function(v){
			return '[img]'+v[0]+'[/img]'
		}
	}
},
{
	0:'<b>[album]</b><br/><nobr>插入相册</nobr>',
	1:"<b>插入相册</b><br/><br/>	[album=相册标题]<br/>http://xxx.com/ooo.jpg<br/>http://xxx.com/xxx.jpg<br/>http://xxx.com/xoo.jpg<br/>http://xxx.com/oox.jpg<br/>[/album]<br/><br/>每行一张图片<br/>第一张图片将作为封面显示	",
	2:{
		0:{'hint':'请输入相册标题'},
		1:{'hint':'请输入图片地址 每行一个','cols':30,'rows':20},
		2:function(v){
			if(v[0])v[0]='='+v[0]
			else v[0]=''
			return '[album'+v[0]+']\n'+v[1]+'\n[/album]'
		}
	}
},
{
	0:'<b>[url]</b><br/><nobr>插入链接</nobr>',
	1:"<b>插入链接</b><br/><br/>	[url]http://xxx.com[/url]<br/><br/>	[url=http://xxx.com]点此链接[/url]<br/>	",
	2:{
		0:{'hint':'请输入链接地址'},
		1:{'hint':'请输入链接文字(可以不填)'},
		2:function(v){
			if (v[1])
				return '[url='+v[0]+']'+v[1]+'[/url]'
			else
				return '[url]'+v[0]+'[/url]'
		}
	}
},
{
	0:'<b>[quote]</b><br/><nobr>引用文字</nobr>',
	1:"<b>引用文字</b><br/><br/>	[quote]<br/>	引用文字<br/>	甲乙丙丁戊己庚辛<br/>	[/quote]<br/>	",
	2:{
		0:{'hint':'请输入引用文字'},
		1:function(v){
			return '[quote]'+v[0]+'[/quote]'
		}
	}
},
{0:'<b>[code]</b><br/><nobr>程序代码</nobr>',1:"<b>程序代码</b><br/><br/>	[code]\n\
	for (i=0; i<10; i++)\n\
	 &nbsp; {\n\
	 &nbsp; &nbsp; print('hello world')\n\
	 &nbsp; }\n\
	[/code]\n\
\n\
	支持以下语法高亮\n\
	[code=lua] …… [/code] lua\n\
	[code=php] …… [/code] php\n\
	[code=c] …… [/code] c\n\
	[code=js] …… [/code] javascript\n\
	[code=xml] …… [/code] xml/html\n\
	[code=py] …… [/code] python\n\
"},
{
	0:'<b>[flash]</b><br/><nobr>插入flash(视频)</nobr>',
	1:"<b>插入flash(视频)</b><br/><br/>	[flash]http://xxx.com/ooo.swf[/flash]<br/><br/>支持youku.com* <span class='silver'>(优酷)</span><br/>tudou.com <span class='silver'>(土豆)</span><br/>bilibili.tv*<br/>acfun.com<br/>letv.com* <span class='silver'>(乐视)</span><br/>qiyi.com <span class='silver'>(奇艺)</span><br/>v.qq.com* <span class='silver'>(腾讯视频)</span><br/>v.163.com* <span class='silver'>(网易视频)</span><br/>www.douyu.tv www.douyutv.com*<span class='silver'>(斗鱼)</span><br/>bogou.tv <span class='silver'>(播狗)</span><br/>feixiong.tv* <span class='silver'>(飞熊)</span><br/>66play.com* <span class='silver'>(66play)</span><br/>等网站<br/><br/>*可直接使用播放页面地址",
	2:{
		0:{'hint':'请输入视频分享地址或播放页面地址'},
		1:function(v){
			return '[flash]'+v[0]+'[/flash]'
		}
	}
},
{0:'<b>[table]</b><br/><nobr>插入表格</nobr>',1:"<b>插入表格</b><br/><br/>[table]\n\
  [tr]\n\
  &nbsp; [td33]第一行第一列，宽度33%[/td]\n\
  &nbsp; [td25]第一行第二列，宽度25%[/td]\n\
  &nbsp; [td]第一行第三列，宽度自动[/td]\n\
  [/tr]\n\
  [tr]\n\
  &nbsp; [td]第二行第一列[/td]\n\
  &nbsp; [td]第二行第二列[/td]\n\
  &nbsp; [td]第二行第三列[/td]\n\
  [/tr]\n\
[/table]\n\
\n\
[table]\n\
  [tr]\n\
  &nbsp; [td top]第一行第一列 顶端对齐[/td]\n\
  &nbsp; [td top]第一行第二列 顶端对齐[/td]\n\
  &nbsp; [td]第一行第三列[/td]\n\
  [/tr]\n\
  [tr]\n\
  &nbsp; [td colspan2 width50]二行第一列和第二列合并 宽度50%[/td]\n\
  &nbsp; [td]第二行第三列[/td]\n\
  [/tr]\n\
  [tr]\n\
  &nbsp; [td colspan=3]第三行第一列和第二列第三列合并[/td]\n\
  [/tr]\n\
[/table]\n\
\n\
[table]\n\
  [tr]\n\
  &nbsp; [td rowspan=3]第一行和第二行第三行第一列合并[/td]\n\
  &nbsp; [td]第一行第二列[/td]\n\
  &nbsp; [td]第一行第三列[/td]\n\
  [/tr]\n\
  [tr]\n\
  &nbsp; [td]第二行第二列[/td]\n\
  &nbsp; [td]第二行第三列[/td]\n\
  [/tr]\n\
  [tr]\n\
  &nbsp; [td]第三行第二列[/td]\n\
  &nbsp; [td]第三行第三列[/td]\n\
  [/tr]\n\
[/table]"},
{
	0:'<b>[tid/pid]</b><br/><nobr>主题/回复</nobr>',
	1:"<b>插入到主题/回复的链接</b><br/><br/>	[tid]主题ID[/tid]<br/>	[tid=主题ID]甲乙丙丁[/tid]<br/>	[pid]回复ID[/pid]<br/>	[pid=回复ID]甲乙丙丁[/pid]<br/>	",
	2:{
		0:{'hint':'请输入ID'},
		1:{'hint':'请输入链接文字(可以不填)'},
		2:{
			'hint':'选择类型',
			'opts':{
				0:{0:'主题',1:'tid'},
				1:{0:'回复',1:'pid'}
				}
			},
		3:function(v){
			if (v[1])
				return '['+v[2]+'='+v[0]+']'+v[1]+'[/'+v[2]+']'
			else
				return '['+v[2]+']'+v[0]+'[/'+v[2]+']'
		}
	}
},
{0:'<b>[dice]</b><br/><nobr>投骰子</nobr>',1:"<b>投一个或多个骰子，并计算总和</b><br/>投骰结果使用随机数计算，以帖子ID和发帖人ID做为种子，故引用他人的投骰代码会得到不同结果<br/><br/>[dice]d100[/dice] 投一个100面的骰子 (1~100)<br/>[dice]2d6[/dice] 投两个6面的骰子 (2~12)<br/>[dice]2d4+2d6[/dice] 投两个4面的骰子和两个6面的骰子 (4~20)<br/><br/>骰子面数不能超过1000,一次最多投10个骰子<br/><br/>注意此随机数结果可推算 不宜用于关键场合<br/>不要用随机数代码编辑到原帖的方式生成结果 以防被事前推知<br/><br/>另需注意编辑内容时<br/>调换[dice]代码顺序 将[dice]代码移入或移出折叠块<br/>等情况下随机数结果会发生改变"},
{
	0:'<b>[crypt]</b><br/><nobr>插入加密的内容</nobr>',
	1:"<b>请使用向导添加</b>",
	2:{
		0:{'hint':'请设置密码<br/><span style="font-weight:normal">(只有使用正确的密码才能浏览加密的内容<br/>发布人和一定权限以上者可以看到密码)</span>'},
		1:{'hint':'请输入要加密的内容','cols':30,'rows':20},
		2:function(v){
			if (v[0].length<5){
				window.alert('请使用更长的密码')
				return false
				}
			if (v[0].match(/[^0-9A-Za-z_]/)){
				window.alert('请使用大小写字母或数字做密码')
				return false
				}
			if(v[1]=='')return false
			if (postfunc && postfunc.addHiddenInfo)
				postfunc.addHiddenInfo('Password: '+v[0])
			return '[crypt]'+ubbcode.crypt.c(ubbcode.crypt.rc4(v[0],v[1]))+'[/crypt]'
		}
	}
},
{
	0:'<b>[collapse]</b><br/><nobr>插入折叠的内容</nobr>',
	1:"<b>折叠的段落只显示提要和展开按钮 浏览者点击按钮后显示内容</b><br/><br/>[collapse=提要]<br/>隐藏的内容……<br/>[/collapse]<br/><br/>[collapse]<br/>没有提要也可以……<br/>[/collapse]<br/>",
	2:{
		0:{'hint':'提要<span style="font-weight:normal">(可不填)</span>'},
		1:{'hint':'请输入要折叠的内容','cols':30,'rows':20},
		2:function(v){
			if (v[0]){
				if (v[0].length>50){
					window.alert('提要过长')
					return false
					}
				v[0]='='+v[0]
				}
			else
				v[0]=''
			if(v[1]=='')return false
			return '[collapse'+v[0]+']'+v[1]+'[/collapse]'
		}
	}
},
{
	0:'<b>[randomblock]</b><br/><nobr>插入随机段落</nobr>',
	1:"<b>一个帖子中所有的随机段落只会显示一个</b><br/><br/>[randomblock]<br/>一段内容……<br/>[/randomblock]<br/><br/>[randomblock]<br/>这两段只会显示其中一个……<br/>[/randomblock]<br/><br/>在版主加粗/加亮标题的主题中的随机段落中可以使用更复杂的排版<br/>具体格式见 <a href='/read.php?pid=220511197' target='_blank'><b>说明贴</b></a><br/><br/><a href='javascript:void(0)' onclick='if(window.adminui){adminui.gameScoreTemplate(event)}else{__SCRIPTS.load(\"admin\",function(){adminui.gameScoreTemplate()},\"gbk\")}'><b>游戏打分模版</b></a>"
},
{
	0:'<b>[@用户名]</b><br/><nobr>发送提醒</nobr>',
	1:"<b>该用户在访问论坛时会收到一个提醒，让他能注意到这个帖子</b><br/>每个用户每天提醒其他用户次数不能超过50<br/>每个帖子里提醒不能超过10个<br/><br/><br/>[@用户名] 或 [@用户数字UID]<br/>"
},
{
	0:'<b>[t.178.com]</b><br/><nobr>引用178尾巴</nobr>',
	1:"<b>引用178尾巴的内容</b><br/><br/>[t.178.com/用户数字id]<br/><br/>引用这个用户的最新一条信息<br/><br/>[t.178.com/#话题#]<br/><br/>引用这个话题的讨论"
}
];
if (__GP['lesser'])
	ubbcode.codeHelpCommon.push({
	0:'<b>[headline]</b><br/><nobr>插入头条</nobr>',
	1:"头条可以包含若干个头条链接(或文字)，数目不限，分为文字和图文两类，请参考以下例子\n\
头条图片高度250像素，宽度不限，图片右侧超出框架部分将不会显示\n\
\n\
&emsp;[headline]\n\
 &emsp; [url=http://www.null.com/null.html]这是一个头条图文链接[/url]\n\
 &emsp; [img]http://www.null.com/null.jpg[/img]\n\
&emsp;[/headline]\n\
\n\
&emsp;[headline]\n\
 &emsp; [tid=100000]这是一个到论坛主题id100000的头条图文链接[/tid]\n\
 &emsp; [img]http://www.null.com/null.jpg[/img]\n\
&emsp;[/headline]\n\
\n\
&emsp;[headline]\n\
 &emsp; [hltxt]这是一个只有文字的图文头条[/hltxt]\n\
 &emsp; [img]http://www.null.com/null.jpg[/img]\n\
&emsp;[/headline]\n\
\n\
&emsp;[headline]\n\
 &emsp; [url=http://www.null.com/null.html][b][color=red]这是一个红色粗体的文字头条链接[/color][/b][/url]\n\
&emsp;[/headline]\n\
\n\
&emsp;[headline]\n\
 &emsp; [tid=100000]这是一个到论坛主题id100000的文字头条链接[/tid]\n\
&emsp;[/headline]\n\
\n\
&emsp;[headline]\n\
 &emsp; [hltxt]这是一个没有链接的文字头条[/hltxt]\n\
&emsp;[/headline]\n\
",
	2:{
		0:{'hint':'添加一个头条<br/><br/>输入头条文字'},
		1:{'hint':'链接地址或主题ID<br/><span style="font-weight:normal">(可以不填)</span>'},
		2:'<b>文字的颜色</b><br/><select><option selected value="">默认</option>\
<option style="background-color: skyblue" value=skyblue>&nbsp; &nbsp; &nbsp; &nbsp;</option>\
<option style="background-color: royalblue" value=royalblue></option>\
<option style="background-color: blue" value=blue></option>\
<option style="background-color: darkblue" value=darkblue></option>\
<option style="background-color: orange" value=orange></option>\
<option style="background-color: orangered" value=orangered></option>\
<option style="background-color: crimson" value=crimson></option>\
<option style="background-color: red" value=red></option>\
<option style="background-color: firebrick" value=firebrick></option>\
<option style="background-color: darkred" value=darkred></option>\
<option style="background-color: green" value=green></option>\
<option style="background-color: limegreen" value=limegreen></option>\
<option style="background-color: seagreen" value=seagreen></option>\
<option style="background-color: teal" value=teal></option>\
<option style="background-color: deeppink" value=deeppink></option>\
<option style="background-color: tomato" value=tomato></option>\
<option style="background-color: coral" value=coral></option>\
<option style="background-color: purple" value=purple></option>\
<option style="background-color: indigo" value=indigo></option>\
<option style="background-color: burlywood" value=burlywood></option>\
<option style="background-color: sandybrown" value=sandybrown></option>\
<option style="background-color: sienna" value=sienna></option>\
<option style="background-color: chocolate" value=chocolate></option>\
<option style="background-color: silver" value=silver></option></select>',
		3:{
		'hint':'字体大小',
		'opts':{
			0:{0:'默认',1:''},
			1:{0:'110%',1:'110'},
			2:{0:'120%',1:'120'},
			3:{0:'130%',1:'130'},
			4:{0:'140%',1:'140'},
			5:{0:'150%',1:'150'}
			}
		},
		4:{
		'hint':'字体样式',
		'opts':{
			0:{0:'默认',1:''},
			1:{0:'粗体',1:'b'},
			2:{0:'斜体',1:'i'}
			}
		},
		5:{'hint':'头条图片地址<br/><span style="font-weight:normal">(可以不填，图片高度为250像素，宽度不限，图片右侧超出框架部分将不会显示)</span>'},
		6:function(v){
			var x = '';
			if(!v[0]){
				if(v[1])v[0]=v[1]
				else return
				}
			if(v[2])v[0] = '[color='+v[2]+']'+v[0]+'[/color]'
			if(v[3])v[0] = '[size='+v[3]+']'+v[0]+'[/size]'
			if(v[4]=='b')v[0] = '[b]'+v[0]+'[/b]'
			if(v[4]=='i')v[0] = '[i]'+v[0]+'[/i]'
			if(v[1]){
				if(parseInt(v[1]))
					v[0]='[tid='+v[1]+']'+v[0]+'[/tid]'
				else
					v[0]='[url='+v[1]+']'+v[0]+'[/url]'
				}
			else
				v[0]='[hltxt]'+v[0]+'[/hltxt]'
			if(v[5])v[0]+='\n[img]'+v[5]+'[/img]'
			return '[headline]\n'+v[0]+'\n[/headline]\n'
			}
	}
})